generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                        String                     @id @default(cuid())
  email                     String                     @unique
  password                  String
  role                      Role                       @default(CLIENT)
  isActive                  Boolean                    @default(true)
  lastLogin                 DateTime?
  createdAt                 DateTime                   @default(now())
  updatedAt                 DateTime                   @updatedAt
  adminSettings             AdminSettings?             @relation("AdminSettings")
  apiKeys                   ApiKey[]
  auditLogs                 AuditLog[]
  emailLogs                 EmailLog[]
  blockedIPs                IPBlacklist[]              @relation("BlockedBy")
  kycSession                KycSession?
  notificationHistory       NotificationHistory[]
  notificationQueue         NotificationQueue[]
  notificationSubscriptions NotificationSubscription[]
  orders                    Order[]
  payInsReconciled          PayIn[]                    @relation("PayInReconciler")
  payInsAsUser              PayIn[]                    @relation("PayInUser")
  payInsVerified            PayIn[]                    @relation("PayInVerifier")
  payOutsProcessed          PayOut[]                   @relation("PayOutProcessor")
  payOutsAsUser             PayOut[]                   @relation("PayOutUser")
  paymentProofs             PaymentProof[]
  profile                   Profile?
  sessionRevocationsBy      SessionRevocation[]        @relation("RevokedBy")
  revokedSessions           SessionRevocation[]        @relation("RevokedSessions")
  twoFactorAuth             TwoFactorAuth?
  userAuditLogs             UserAuditLog[]             @relation("UserAuditLogs")
  kycLevelData              UserKycLevel?              @relation("UserKycLevelRelation")
  userWallets               UserWallet[]

  @@index([email])
  @@index([role])
}

model Profile {
  id           String    @id @default(cuid())
  userId       String    @unique
  firstName    String
  lastName     String
  phoneNumber  String?
  country      String
  city         String?
  address      String?
  postalCode   String?
  dateOfBirth  DateTime?
  nationality  String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  phoneCountry String?
  placeOfBirth String?
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([country])
}

model KycSession {
  id                   String        @id @default(cuid())
  userId               String        @unique
  kycaidVerificationId String?       @unique
  kycaidApplicantId    String?
  kycaidFormId         String?
  status               KycStatus     @default(PENDING)
  submittedAt          DateTime?
  reviewedAt           DateTime?
  reviewedBy           String?
  reviewNotes          String?
  completedAt          DateTime?
  expiresAt            DateTime?
  rejectionReason      String?
  webhookData          Json?
  metadata             Json?
  attempts             Int           @default(0)
  lastAttemptAt        DateTime?
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  kycProviderId        String?
  applicantId          String?
  verificationId       String?       @unique
  documents            KycDocument[]
  formData             KycFormData[]
  profile              KycProfile?
  user                 User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([kycaidVerificationId])
  @@index([kycProviderId])
  @@index([applicantId])
  @@index([verificationId])
}

model Currency {
  code               String                      @id
  name               String
  symbol             String
  decimals           Int                         @default(8)
  precision          Int                         @default(8)
  coingeckoId        String
  isActive           Boolean                     @default(true)
  priority           Int                         @default(0)
  isToken            Boolean                     @default(false)
  iconUrl            String?
  minOrderAmount     Float                       @default(0.001)
  maxOrderAmount     Float                       @default(100)
  createdAt          DateTime                    @default(now())
  updatedAt          DateTime                    @updatedAt
  blockchainNetworks CurrencyBlockchainNetwork[]
  orders             Order[]
  payIns             PayIn[]                     @relation("PayInCrypto")
  payOuts            PayOut[]
  paymentAccounts    PaymentAccount[]            @relation("PaymentAccountCrypto")
  platformWallets    PlatformWallet[]
  rateHistory        RateHistory[]               @relation("CryptoCurrency")
  tradingPairs       TradingPair[]               @relation("CryptoCurrency")
  userWallets        UserWallet[]

  @@index([isToken])
}

model FiatCurrency {
  code            String           @id
  name            String
  symbol          String
  precision       Int              @default(2)
  isActive        Boolean          @default(true)
  priority        Int              @default(0)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  bankDetails     BankDetails[]
  feeProfiles     FeeProfile[]
  limitsMatrix    LimitsMatrix[]
  orders          Order[]
  payIns          PayIn[]
  payOuts         PayOut[]         @relation("PayOutFiat")
  paymentAccounts PaymentAccount[]
  rateHistory     RateHistory[]    @relation("FiatCurrency")
  tradingPairs    TradingPair[]    @relation("FiatCurrency")
}

model TradingPair {
  id              String       @id @default(cuid())
  cryptoCode      String
  fiatCode        String
  isActive        Boolean      @default(true)
  minCryptoAmount Float
  maxCryptoAmount Float
  minFiatAmount   Float
  maxFiatAmount   Float
  feePercent      Float        @default(1.5)
  priority        Int          @default(0)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  crypto          Currency     @relation("CryptoCurrency", fields: [cryptoCode], references: [code])
  fiat            FiatCurrency @relation("FiatCurrency", fields: [fiatCode], references: [code])

  @@unique([cryptoCode, fiatCode])
  @@index([isActive])
}

model RateHistory {
  id         String       @id @default(cuid())
  cryptoCode String
  fiatCode   String
  rate       Float
  source     String       @default("coingecko")
  createdAt  DateTime     @default(now())
  crypto     Currency     @relation("CryptoCurrency", fields: [cryptoCode], references: [code])
  fiat       FiatCurrency @relation("FiatCurrency", fields: [fiatCode], references: [code])

  @@index([cryptoCode, fiatCode, createdAt])
}

model Order {
  id                String               @id @default(cuid())
  userId            String
  currencyCode      String
  fiatCurrencyCode  String
  paymentReference  String               @unique
  cryptoAmount      Float
  fiatAmount        Float
  rate              Float
  feePercent        Float
  feeAmount         Float
  totalFiat         Float
  userWalletId      String?
  walletAddress     String
  blockchainCode    String?
  paymentMethodCode String?
  status            OrderStatus          @default(PENDING)
  createdByAdmin    Boolean              @default(false)
  adminNotes        String?
  transactionHash   String?
  processedBy       String?
  processedAt       DateTime?
  expiresAt         DateTime
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  blockchain        BlockchainNetwork?   @relation(fields: [blockchainCode], references: [code])
  currency          Currency             @relation(fields: [currencyCode], references: [code])
  fiatCurrency      FiatCurrency         @relation(fields: [fiatCurrencyCode], references: [code])
  paymentMethod     PaymentMethod?       @relation(fields: [paymentMethodCode], references: [code])
  user              User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  userWallet        UserWallet?          @relation(fields: [userWalletId], references: [id])
  statusHistory     OrderStatusHistory[]
  payIn             PayIn?
  payOut            PayOut?
  paymentProofs     PaymentProof[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([paymentReference])
  @@index([userWalletId])
  @@index([blockchainCode])
}

model PaymentProof {
  id         String   @id @default(cuid())
  orderId    String
  fileUrl    String
  fileName   String
  fileSize   Int
  mimeType   String
  uploadedBy String
  uploadedAt DateTime @default(now())
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [uploadedBy], references: [id])

  @@index([orderId])
}

model PaymentAccount {
  id                 String             @id @default(cuid())
  code               String             @unique
  name               String
  type               PaymentAccountType
  description        String?
  currency           String?
  bankName           String?
  bankAddress        String?
  accountHolder      String?
  iban               String?
  swift              String?
  bic                String?
  sortCode           String?
  referenceTemplate  String?
  cryptocurrencyCode String?
  blockchainCode     String?
  address            String?
  balance            Float?
  minBalance         Float?
  instructions       String?
  isActive           Boolean            @default(true)
  isDefault          Boolean            @default(false)
  priority           Int                @default(0)
  lastUsed           DateTime?
  lastChecked        DateTime?
  alertsEnabled      Boolean            @default(true)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  createdBy          String?
  payOuts            PayOut[]           @relation("PaymentAccountPayOuts")
  blockchain         BlockchainNetwork? @relation(fields: [blockchainCode], references: [code])
  cryptocurrency     Currency?          @relation("PaymentAccountCrypto", fields: [cryptocurrencyCode], references: [code])
  fiatCurrency       FiatCurrency?      @relation(fields: [currency], references: [code])
  paymentMethods     PaymentMethod[]

  @@index([type, isActive])
  @@index([currency])
  @@index([cryptocurrencyCode])
  @@index([isDefault])
}

model BankDetails {
  id                String          @id @default(cuid())
  currency          String
  bankName          String
  bankAddress       String?
  accountHolder     String
  iban              String
  swift             String?
  bic               String?
  sortCode          String?
  referenceTemplate String          @default("APR-{orderId}")
  instructions      String?
  isActive          Boolean         @default(true)
  priority          Int             @default(0)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  fiatCurrency      FiatCurrency    @relation(fields: [currency], references: [code])
  paymentMethods    PaymentMethod[]

  @@index([currency, isActive])
}

model PlatformWallet {
  id             String            @id @default(cuid())
  currencyCode   String
  blockchainCode String
  address        String            @unique
  label          String
  isActive       Boolean           @default(true)
  balance        Float             @default(0)
  lastUsed       DateTime?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  payOuts        PayOut[]
  blockchain     BlockchainNetwork @relation(fields: [blockchainCode], references: [code])
  currency       Currency          @relation(fields: [currencyCode], references: [code])

  @@index([currencyCode, isActive])
}

model PayIn {
  id                 String             @id @default(cuid())
  orderId            String             @unique
  userId             String
  amount             Float
  fiatCurrencyCode   String?
  cryptocurrencyCode String?
  currencyType       CurrencyType
  paymentMethodCode  String?
  senderName         String?
  senderAccount      String?
  senderBank         String?
  reference          String?
  networkCode        String?
  senderAddress      String?
  transactionHash    String?
  blockNumber        Int?
  confirmations      Int                @default(0)
  transactionId      String?            @unique
  status             PayInStatus        @default(PENDING)
  expectedAmount     Float
  receivedAmount     Float?
  amountMismatch     Boolean            @default(false)
  verifiedBy         String?
  verifiedAt         DateTime?
  verificationNotes  String?
  reconciledWith     String?
  reconciledAt       DateTime?
  reconciledBy       String?
  proofUrls          String[]
  explorerUrl        String?
  paymentDate        DateTime?
  receivedDate       DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  approvalRequired   Boolean            @default(true)
  approvedAt         DateTime?
  approvedBy         String?
  initiatedAt        DateTime?
  initiatedBy        String?
  approver           Admin?             @relation("PayInApprover", fields: [approvedBy], references: [id])
  cryptocurrency     Currency?          @relation("PayInCrypto", fields: [cryptocurrencyCode], references: [code])
  fiatCurrency       FiatCurrency?      @relation(fields: [fiatCurrencyCode], references: [code])
  initiator          Admin?             @relation("PayInInitiator", fields: [initiatedBy], references: [id])
  network            BlockchainNetwork? @relation("PayInNetwork", fields: [networkCode], references: [code])
  order              Order              @relation(fields: [orderId], references: [id], onDelete: Cascade)
  paymentMethod      PaymentMethod?     @relation(fields: [paymentMethodCode], references: [code])
  reconciler         User?              @relation("PayInReconciler", fields: [reconciledBy], references: [id])
  user               User               @relation("PayInUser", fields: [userId], references: [id], onDelete: Cascade)
  verifier           User?              @relation("PayInVerifier", fields: [verifiedBy], references: [id])

  @@index([orderId])
  @@index([userId])
  @@index([fiatCurrencyCode])
  @@index([cryptocurrencyCode])
  @@index([status])
  @@index([currencyType])
  @@index([paymentDate])
  @@index([transactionId])
  @@index([transactionHash])
  @@index([createdAt])
}

model PayOut {
  id                 String             @id @default(cuid())
  orderId            String             @unique
  userId             String
  amount             Float
  fiatCurrencyCode   String?
  cryptocurrencyCode String?
  currencyType       CurrencyType
  networkCode        String?
  destinationAddress String?
  destinationTag     String?
  userWalletId       String?
  transactionHash    String?            @unique
  explorerUrl        String?
  blockNumber        Int?
  confirmations      Int                @default(0)
  networkFee         Float?
  networkFeeCurrency String?
  recipientName      String?
  recipientAccount   String?
  recipientBank      String?
  paymentReference   String?
  bankTransactionId  String?
  paymentMethodCode  String?
  status             PayOutStatus       @default(PENDING)
  failureReason      String?
  retryCount         Int                @default(0)
  processedBy        String?
  processedAt        DateTime?
  processingNotes    String?
  paymentAccountId   String?
  fromWalletId       String?
  scheduledFor       DateTime?
  sentAt             DateTime?
  confirmedAt        DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  approvalRequired   Boolean            @default(true)
  approvedAt         DateTime?
  approvedBy         String?
  initiatedAt        DateTime?
  initiatedBy        String?
  requiresStepUpMfa  Boolean            @default(false)
  approver           Admin?             @relation("PayOutApprover", fields: [approvedBy], references: [id])
  cryptocurrency     Currency?          @relation(fields: [cryptocurrencyCode], references: [code])
  fiatCurrency       FiatCurrency?      @relation("PayOutFiat", fields: [fiatCurrencyCode], references: [code])
  platformWallet     PlatformWallet?    @relation(fields: [fromWalletId], references: [id])
  initiator          Admin?             @relation("PayOutInitiator", fields: [initiatedBy], references: [id])
  network            BlockchainNetwork? @relation(fields: [networkCode], references: [code])
  order              Order              @relation(fields: [orderId], references: [id], onDelete: Cascade)
  paymentAccount     PaymentAccount?    @relation("PaymentAccountPayOuts", fields: [paymentAccountId], references: [id])
  paymentMethod      PaymentMethod?     @relation("PayOutMethod", fields: [paymentMethodCode], references: [code])
  processor          User?              @relation("PayOutProcessor", fields: [processedBy], references: [id])
  user               User               @relation("PayOutUser", fields: [userId], references: [id])
  userWallet         UserWallet?        @relation(fields: [userWalletId], references: [id])

  @@index([orderId])
  @@index([userId])
  @@index([fiatCurrencyCode])
  @@index([cryptocurrencyCode])
  @@index([status])
  @@index([transactionHash])
  @@index([destinationAddress])
  @@index([currencyType])
  @@index([scheduledFor])
  @@index([createdAt])
}

model AdminAuditLog {
  id             String                  @id @default(cuid())
  orgId          String?
  adminId        String
  adminEmail     String?
  adminRole      String?
  action         String
  entityType     String
  entityId       String
  diffBefore     Json?
  diffAfter      Json?
  changes        Json?
  context        Json?
  reason         String?
  mfaRequired    Boolean                 @default(false)
  mfaMethod      String?
  mfaVerifiedAt  DateTime?
  mfaEventId     String?
  severity       String                  @default("INFO")
  isReviewable   Boolean                 @default(false)
  reviewedAt     DateTime?
  reviewedBy     String?
  createdAt      DateTime                @default(now())
  freezeChecksum String?
  reviewNotes    String?
  admin          Admin                   @relation("AdminAuditLogs", fields: [adminId], references: [id], onDelete: Cascade)
  mfaEvent       MfaEvent?               @relation("AdminMfaLogs", fields: [mfaEventId], references: [id])
  readBy         AdminNotificationRead[]

  @@index([orgId, createdAt(sort: Desc)])
  @@index([adminId, createdAt(sort: Desc)])
  @@index([entityType, entityId])
  @@index([action])
  @@index([severity])
  @@index([isReviewable])
  @@index([mfaEventId])
}

model AdminNotificationRead {
  id         String        @id @default(cuid())
  adminId    String
  auditLogId String
  readAt     DateTime      @default(now())
  admin      Admin         @relation("AdminNotificationReads", fields: [adminId], references: [id], onDelete: Cascade)
  auditLog   AdminAuditLog @relation(fields: [auditLogId], references: [id], onDelete: Cascade)

  @@unique([adminId, auditLogId])
  @@index([adminId, readAt])
}

model UserAuditLog {
  id             String    @id @default(cuid())
  orgId          String?
  userId         String
  userEmail      String?
  userRole       String?
  action         String
  entityType     String
  entityId       String
  diffBefore     Json?
  diffAfter      Json?
  changes        Json?
  context        Json?
  mfaRequired    Boolean   @default(false)
  mfaMethod      String?
  mfaVerifiedAt  DateTime?
  mfaEventId     String?
  createdAt      DateTime  @default(now())
  freezeChecksum String?
  mfaEvent       MfaEvent? @relation("UserMfaLogs", fields: [mfaEventId], references: [id])
  user           User      @relation("UserAuditLogs", fields: [userId], references: [id], onDelete: Cascade)

  @@index([orgId, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@index([entityType, entityId])
  @@index([action])
  @@index([mfaEventId])
}

model AuditLog {
  id             String    @id @default(cuid())
  userId         String?
  action         String
  entity         String
  entityId       String
  oldValue       Json?
  newValue       Json?
  metadata       Json?
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime  @default(now())
  adminId        String?
  changes        Json?
  city           String?
  country        String?
  hash           String?
  isReviewable   Boolean   @default(false)
  mfaMethod      String?
  mfaRequired    Boolean   @default(false)
  mfaVerifiedAt  DateTime?
  reason         String?
  reviewedAt     DateTime?
  reviewedBy     String?
  severity       String    @default("INFO")
  userEmail      String?
  userRole       String?
  actorEmail     String?
  actorId        String?
  actorRole      String?
  actorType      String?
  context        Json?
  diffAfter      Json?
  diffBefore     Json?
  entityType     String?
  freezeChecksum String?
  mfaEventId     String?
  orgId          String?
  admin          Admin?    @relation(fields: [adminId], references: [id])
  mfaEvent       MfaEvent? @relation("LegacyMfaLogs", fields: [mfaEventId], references: [id])
  user           User?     @relation(fields: [userId], references: [id])

  @@index([orgId, createdAt(sort: Desc)])
  @@index([actorType, actorId])
  @@index([userId])
  @@index([adminId])
  @@index([entity, entityId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
  @@index([severity])
  @@index([isReviewable])
  @@index([userRole])
  @@index([mfaEventId])
}

model MfaEvent {
  id               String          @id @default(cuid())
  orgId            String?
  actorId          String
  actorType        String
  actorRole        String?
  actionType       String
  method           String
  userVerification Boolean?
  credentialIdHash String?
  aaguid           String?
  signCount        Int?
  challengeId      String?
  result           String
  errorCode        String?
  errorMessage     String?
  ipAddress        String
  userAgent        String?
  deviceInfo       Json?
  createdAt        DateTime        @default(now())
  adminAuditLogs   AdminAuditLog[] @relation("AdminMfaLogs")
  legacyLogs       AuditLog[]      @relation("LegacyMfaLogs")
  admin            Admin           @relation("AdminMfaEvents", fields: [actorId], references: [id], onDelete: SetNull)
  userAuditLogs    UserAuditLog[]  @relation("UserMfaLogs")

  @@index([actorId, createdAt(sort: Desc)])
  @@index([orgId, createdAt(sort: Desc)])
  @@index([challengeId])
  @@index([result])
  @@index([actionType])
}

model SystemLog {
  id           String   @id @default(cuid())
  method       String?
  statusCode   Int?
  responseTime Int?
  errorMessage String?
  errorStack   String?
  metadata     Json?
  createdAt    DateTime @default(now())
  endpoint     String?
  eventType    String?
  level        String?
  orgId        String?
  payload      Json?
  requestBody  Json?
  responseBody Json?
  source       String?

  @@index([source, createdAt(sort: Desc)])
  @@index([level, createdAt(sort: Desc)])
  @@index([orgId, createdAt(sort: Desc)])
  @@index([eventType])
}

model EmailLog {
  id            String         @id @default(cuid())
  userId        String?
  recipient     String
  subject       String
  template      String
  status        EmailStatus    @default(PENDING)
  sentAt        DateTime?
  deliveredAt   DateTime?
  failedAt      DateTime?
  error         String?
  metadata      Json?
  createdAt     DateTime       @default(now())
  templateId    String?
  emailTemplate EmailTemplate? @relation("TemplateUsed", fields: [templateId], references: [id])
  user          User?          @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([template])
  @@index([templateId])
  @@index([createdAt])
}

model SystemSettings {
  key         String      @id
  value       String
  type        SettingType @default(STRING)
  category    String      @default("general")
  description String?
  isPublic    Boolean     @default(false)
  updatedAt   DateTime    @updatedAt
  updatedBy   String?

  @@index([category])
  @@index([isPublic])
}

model BlockchainNetwork {
  id               String                      @id @default(cuid())
  code             String                      @unique
  name             String
  symbol           String?
  nativeToken      String
  nativeAsset      String?
  explorerUrl      String
  rpcUrl           String?
  chainId          Int?
  minConfirmations Int                         @default(12)
  confirmations    Int                         @default(12)
  isActive         Boolean                     @default(true)
  priority         Int                         @default(0)
  metadata         Json?
  createdAt        DateTime                    @default(now())
  updatedAt        DateTime                    @updatedAt
  currencies       CurrencyBlockchainNetwork[]
  orders           Order[]
  payIns           PayIn[]                     @relation("PayInNetwork")
  payOuts          PayOut[]
  paymentAccounts  PaymentAccount[]
  platformWallets  PlatformWallet[]
  transactions     Transaction[]
  userWallets      UserWallet[]

  @@index([isActive])
}

model CurrencyBlockchainNetwork {
  id              String            @id @default(cuid())
  currencyCode    String
  blockchainCode  String
  contractAddress String?
  isNative        Boolean           @default(false)
  isActive        Boolean           @default(true)
  priority        Int               @default(0)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  blockchain      BlockchainNetwork @relation(fields: [blockchainCode], references: [code], onDelete: Cascade)
  currency        Currency          @relation(fields: [currencyCode], references: [code], onDelete: Cascade)

  @@unique([currencyCode, blockchainCode])
  @@index([currencyCode])
  @@index([blockchainCode])
  @@index([isActive])
}

model UserWallet {
  id             String            @id @default(cuid())
  userId         String
  blockchainCode String
  currencyCode   String
  address        String
  label          String?
  isVerified     Boolean           @default(false)
  isDefault      Boolean           @default(false)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  orders         Order[]
  payOuts        PayOut[]
  blockchain     BlockchainNetwork @relation(fields: [blockchainCode], references: [code])
  currency       Currency          @relation(fields: [currencyCode], references: [code])
  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, address])
  @@index([userId, currencyCode])
  @@index([address])
}

model OrderStatusHistory {
  id        String      @id @default(cuid())
  orderId   String
  oldStatus OrderStatus
  newStatus OrderStatus
  changedBy String
  note      String?
  createdAt DateTime    @default(now())
  order     Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([createdAt])
}

model KycFormField {
  id         String   @id @default(cuid())
  fieldName  String   @unique
  label      String
  fieldType  String
  isRequired Boolean  @default(true)
  isEnabled  Boolean  @default(true)
  category   String
  validation Json?
  options    Json?
  priority   Int      @default(0)
  
  // Conditional logic (Phase 2)
  dependsOn  String?  // Parent field name (e.g., 'pep_status', 'employment_status')
  showWhen   Json?    // Condition object: {"operator": "!=", "value": "NO"}
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([category])
  @@index([isEnabled])
  @@index([dependsOn])
}

model KycDocument {
  id               String     @id @default(cuid())
  kycSessionId     String
  documentType     String
  fileUrl          String
  fileName         String
  fileSize         Int
  mimeType         String
  verifiedByAI     Boolean    @default(false)
  verificationData Json?
  uploadedAt       DateTime   @default(now())
  kycSession       KycSession @relation(fields: [kycSessionId], references: [id], onDelete: Cascade)

  @@index([kycSessionId])
  @@index([documentType])
}

model KycFormData {
  id           String     @id @default(cuid())
  kycSessionId String
  fieldName    String
  fieldValue   String
  createdAt    DateTime   @default(now())
  kycSession   KycSession @relation(fields: [kycSessionId], references: [id], onDelete: Cascade)

  @@unique([kycSessionId, fieldName])
  @@index([kycSessionId])
}

model PaymentMethod {
  code                  String           @id @unique
  name                  String
  description           String?
  type                  String
  direction             PaymentDirection @default(IN)
  providerType          ProviderType     @default(MANUAL)
  automationLevel       AutomationLevel  @default(MANUAL)
  currency              String
  supportedNetworks     String[]         @default([])
  pspConnector          String?
  paymentAccountId      String?
  bankAccountId         String?
  minAmount             Float?
  maxAmount             Float?
  feeFixed              Float            @default(0)
  feePercent            Float            @default(0)
  processingTime        String?
  instructions          String?
  iconUrl               String?
  priority              Int              @default(0)
  config                Json?
  isActive              Boolean          @default(true)
  isAvailableForClients Boolean          @default(true)
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  createdBy             String?
  limitsMatrix          LimitsMatrix[]
  orders                Order[]
  payIns                PayIn[]
  payOuts               PayOut[]         @relation("PayOutMethod")
  bankAccount           BankDetails?     @relation(fields: [bankAccountId], references: [id])
  paymentAccount        PaymentAccount?  @relation(fields: [paymentAccountId], references: [id])
  psp                   PspConnector?    @relation(fields: [pspConnector], references: [code])

  @@index([type, isActive])
  @@index([currency])
  @@index([direction])
  @@index([providerType])
  @@index([automationLevel])
  @@index([isAvailableForClients])
}

model ManualRate {
  id         String    @id @default(cuid())
  cryptoCode String
  fiatCode   String
  rate       Float
  validFrom  DateTime  @default(now())
  validTo    DateTime?
  isActive   Boolean   @default(true)
  createdBy  String
  reason     String?
  createdAt  DateTime  @default(now())

  @@index([cryptoCode, fiatCode, isActive])
  @@index([validFrom, validTo])
}

model IntegrationSetting {
  id         String    @id @default(cuid())
  service    String    @unique
  isEnabled  Boolean   @default(true)
  config     Json
  lastTested DateTime?
  status     String    @default("unconfigured")
  errorLog   String?
  updatedAt  DateTime  @updatedAt
  updatedBy  String?

  @@index([service])
  @@index([status])
}

model ApiKey {
  id          String        @id @default(cuid())
  userId      String?
  key         String
  keyHash     String        @unique
  name        String
  prefix      String
  permissions Json
  isActive    Boolean       @default(true)
  expiresAt   DateTime?
  lastUsedAt  DateTime?
  lastUsedIp  String?
  usageCount  Int           @default(0)
  rateLimit   Int           @default(100)
  createdBy   String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  user        User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  usage       ApiKeyUsage[]
  webhooks    Webhook[]

  @@index([keyHash])
  @@index([userId])
  @@index([isActive])
  @@index([prefix])
}

model ApiKeyUsage {
  id           String   @id @default(cuid())
  apiKeyId     String
  endpoint     String
  method       String
  statusCode   Int
  responseTime Int
  ipAddress    String
  userAgent    String?
  errorMessage String?
  createdAt    DateTime @default(now())
  apiKey       ApiKey   @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)

  @@index([apiKeyId, createdAt])
  @@index([endpoint])
  @@index([createdAt])
}

model IpRule {
  id        String    @id @default(cuid())
  ipAddress String    @unique
  type      String
  reason    String?
  createdBy String
  createdAt DateTime  @default(now())
  expiresAt DateTime?

  @@index([ipAddress, type])
  @@index([type])
}

model TwoFactorAuth {
  id              String    @id @default(cuid())
  userId          String    @unique
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  passkeys        Json?
  passkeysEnabled Boolean   @default(false)
  totpEnabled     Boolean   @default(false)
  totpSecret      String?
  totpVerifiedAt  DateTime?
  backupCodes     Json?
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model DataRetentionPolicy {
  id            String   @id @default(cuid())
  entityType    String   @unique
  retentionDays Int
  autoDelete    Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model RateProvider {
  code          String         @id @unique
  name          String
  type          String
  weight        Float          @default(1.0)
  isActive      Boolean        @default(true)
  apiConfig     Json?
  priority      Int            @default(0)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  rateSnapshots RateSnapshot[]

  @@index([isActive])
  @@index([type])
}

model RateSnapshot {
  id         String       @id @default(cuid())
  providerId String
  assetCode  String
  fiatCode   String
  rate       Float
  timestamp  DateTime     @default(now())
  provider   RateProvider @relation(fields: [providerId], references: [code])

  @@index([assetCode, fiatCode, timestamp])
  @@index([providerId, timestamp])
}

model FeeProfile {
  code              String        @id @unique
  name              String
  spreadBps         Int
  fixedFeeFiat      Float         @default(0)
  fiatCurrency      String?
  networkFeePolicy  String        @default("pass-through")
  networkFeeAmount  Float?
  networkFeePercent Float?
  isActive          Boolean       @default(true)
  priority          Int           @default(0)
  description       String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  fiat              FiatCurrency? @relation(fields: [fiatCurrency], references: [code])

  @@index([isActive])
}

model KycLevel {
  code         String         @id @unique
  name         String
  description  String?
  allowMethods String[]
  requirements Json?
  dailyLimit   Float?
  monthlyLimit Float?
  isActive     Boolean        @default(true)
  priority     Int            @default(0)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  limitsMatrix LimitsMatrix[]

  @@index([isActive])
}

model LimitsMatrix {
  id            String        @id @default(cuid())
  kycLevel      String
  paymentMethod String
  fiatCurrency  String
  period        String
  limitAmount   Float
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  fiatRel       FiatCurrency  @relation(fields: [fiatCurrency], references: [code])
  kycLevelRel   KycLevel      @relation(fields: [kycLevel], references: [code])
  paymentRel    PaymentMethod @relation(fields: [paymentMethod], references: [code])

  @@unique([kycLevel, paymentMethod, fiatCurrency, period])
  @@index([kycLevel])
  @@index([paymentMethod])
}

model PspConnector {
  code               String          @id @unique
  name               String
  capabilities       String[]
  settlementCurrency String
  apiConfig          Json?
  isEnabled          Boolean         @default(true)
  lastTested         DateTime?
  status             String          @default("unconfigured")
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  paymentMethods     PaymentMethod[]

  @@index([isEnabled])
  @@index([status])
}

model OrderStatusConfig {
  code         String   @id @unique
  name         String
  description  String?
  color        String   @default("#6b7280")
  isTerminal   Boolean  @default(false)
  priority     Int      @default(0)
  nextStatuses String[] @default([])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([priority])
}

model TransactionStatusConfig {
  code        String   @id @unique
  name        String
  description String?
  color       String   @default("#6b7280")
  isTerminal  Boolean  @default(false)
  priority    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([priority])
}

model Transaction {
  id            String            @id @default(cuid())
  orderId       String?
  walletId      String?
  txHash        String?           @unique
  currencyCode  String
  chainCode     String
  amount        Float
  fee           Float?
  statusCode    String
  confirmations Int               @default(0)
  broadcastAt   DateTime?
  confirmedAt   DateTime?
  failedAt      DateTime?
  errorMessage  String?
  metadata      Json?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  chain         BlockchainNetwork @relation(fields: [chainCode], references: [code])

  @@index([orderId])
  @@index([txHash])
  @@index([statusCode])
  @@index([chainCode])
}

model WidgetConfig {
  id               String   @id @default(cuid())
  code             String   @unique
  name             String
  supportedPairs   String[]
  defaultFiat      String
  defaultCrypto    String?
  theme            Json
  minKycForMethods Json
  allowedMethods   String[]
  feeProfileCode   String?
  isActive         Boolean  @default(true)
  domain           String?
  webhookUrl       String?
  apiKey           String?
  metadata         Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([code])
  @@index([isActive])
}

model UserKycLevel {
  userId    String   @unique
  kycLevel  String
  updatedAt DateTime @updatedAt
  updatedBy String?
  user      User     @relation("UserKycLevelRelation", fields: [userId], references: [id], onDelete: Cascade)

  @@index([kycLevel])
}

model Integration {
  id          String    @id @default(cuid())
  service     String    @unique
  isEnabled   Boolean   @default(false)
  status      String    @default("inactive")
  apiKey      String?
  apiEndpoint String?
  lastTested  DateTime?
  config      Json?
  rates       Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([service])
  @@index([isEnabled])
  @@index([status])
}

model IPBlacklist {
  id              String    @id @default(cuid())
  ipAddress       String    @unique
  reason          String
  blockedBy       String
  isActive        Boolean   @default(true)
  expiresAt       DateTime?
  blockedAttempts Int       @default(0)
  lastAttemptAt   DateTime?
  metadata        Json?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  blockedByUser   User      @relation("BlockedBy", fields: [blockedBy], references: [id])

  @@index([ipAddress])
  @@index([isActive])
  @@index([expiresAt])
  @@index([blockedBy])
}

model SessionRevocation {
  id            String   @id @default(cuid())
  sessionKey    String   @unique
  userId        String
  ipAddress     String
  deviceType    String?
  browser       String?
  os            String?
  revokedBy     String
  reason        String?
  expiresAt     DateTime
  createdAt     DateTime @default(now())
  revokedByUser User     @relation("RevokedBy", fields: [revokedBy], references: [id])
  user          User     @relation("RevokedSessions", fields: [userId], references: [id], onDelete: Cascade)

  @@index([sessionKey])
  @@index([userId])
  @@index([ipAddress])
  @@index([expiresAt])
  @@index([createdAt])
}

model AdminSettings {
  id                  String   @id @default(cuid())
  userId              String?  @unique
  sessionTimeout      Int      @default(30)
  twoFactorEnabled    Boolean  @default(false)
  twoFactorMethod     String?
  loginNotifications  Boolean  @default(true)
  activityDigest      Boolean  @default(false)
  securityAlerts      Boolean  @default(true)
  allowedIPs          String[] @default([])
  blockUnknownDevices Boolean  @default(false)
  logAllActions       Boolean  @default(true)
  retainLogsFor       Int      @default(90)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  adminId             String?  @unique
  idleTimeout         Int      @default(15)
  maxSessionDuration  Int      @default(8)
  rememberDevice      Boolean  @default(false)
  requireMfaAlways    Boolean  @default(false)
  requireStepUpFor    String[] @default([])
  admin               Admin?   @relation("AdminToSettings", fields: [adminId], references: [id], onDelete: Cascade)
  user                User?    @relation("AdminSettings", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([adminId])
}

model KycProfile {
  id                     String     @id @default(cuid())
  kycSessionId           String     @unique
  firstName              String
  lastName               String
  dateOfBirth            DateTime
  placeOfBirth           String?
  nationality            String
  email                  String
  phone                  String
  phoneCountry           String?
  addressStreet          String?
  addressCity            String?
  addressRegion          String?
  addressCountry         String?
  addressPostal          String?
  idType                 String?
  idNumber               String?
  idIssuingCountry       String?
  idIssuingAuth          String?
  idIssueDate            DateTime?
  idExpiryDate           DateTime?
  idScanFront            String?
  idScanBack             String?
  livenessSelfie         String?
  pepStatus              Boolean    @default(false)
  pepCategory            String?
  sanctionsScreeningDone Boolean    @default(false)
  sanctionsProvider      String?
  sanctionsScreeningDate DateTime?
  sanctionsResult        String?
  sanctionsMatches       Json?
  employmentStatus       String?
  occupation             String?
  employerName           String?
  purposeOfAccount       String?
  intendedUse            String?
  expectedVolume         Float?
  expectedFrequency      String?
  expectedCountries      String[]
  sourceOfFunds          String?
  sourceOfWealth         String?
  riskScore              Int?
  riskFactors            Json?
  riskJustification      String?
  consentKyc             Boolean    @default(false)
  consentAml             Boolean    @default(false)
  consentTfr             Boolean    @default(false)
  consentPrivacy         Boolean    @default(false)
  termsVersion           String?
  privacyVersion         String?
  ipAddress              String?
  userAgent              String?
  completedAt            DateTime?
  verifiedBy             String?
  verifiedAt             DateTime?
  createdAt              DateTime   @default(now())
  updatedAt              DateTime   @updatedAt
  kycSession             KycSession @relation(fields: [kycSessionId], references: [id], onDelete: Cascade)

  @@index([kycSessionId])
  @@index([email])
  @@index([nationality])
  @@index([pepStatus])
}

model LegalDocument {
  id                String           @id @default(cuid())
  key               String           @unique
  title             String
  description       String?
  slug              String?          @unique
  category          DocumentCategory
  isRequired        Boolean          @default(false)
  content           Json
  htmlContent       String?
  plainText         String?
  status            DocumentStatus   @default(DRAFT)
  publishedAt       DateTime?
  publishedBy       String?
  version           Int              @default(1)
  previousVersionId String?
  isLatest          Boolean          @default(true)
  metaTitle         String?
  metaDescription   String?
  ogImage           String?
  isPublic          Boolean          @default(false)
  allowedRoles      String[]         @default(["ADMIN"])
  createdBy         String
  updatedBy         String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  changeLog         Json?

  @@index([key])
  @@index([slug])
  @@index([category])
  @@index([status])
  @@index([isPublic])
  @@index([publishedAt])
}

model DocumentTemplate {
  id          String           @id @default(cuid())
  name        String
  description String?
  category    DocumentCategory
  content     Json
  variables   Json?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([category])
}

model Admin {
  id                String                  @id @default(cuid())
  email             String?
  password          String?
  firstName         String
  lastName          String
  role              AdminRole               @default(ADMIN)
  isActive          Boolean                 @default(true)
  isSuspended       Boolean                 @default(false)
  suspendedUntil    DateTime?
  lastLogin         DateTime?
  authMethod        AuthMethod              @default(PASSWORD)
  ssoProvider       String?
  ssoSubject        String?
  createdAt         DateTime                @default(now())
  createdBy         String?
  updatedAt         DateTime                @updatedAt
  setupToken        String?                 @unique
  setupTokenExpiry  DateTime?
  canApprovePayout  Boolean                 @default(false)
  canInitiatePayout Boolean                 @default(false)
  department        String?
  employeeId        String?                 @unique @default(cuid())
  invitedAt         DateTime?
  invitedBy         String?
  jobTitle          String?
  locale            String                  @default("en")
  managerId         String?
  orgId             String                  @default("default")
  scope             Json?
  status            AdminStatus             @default(ACTIVE)
  timezone          String                  @default("UTC")
  workEmail         String?                 @unique
  roleCode          String?                 @default("ADMIN")
  inviter           Admin?                  @relation("AdminInviter", fields: [invitedBy], references: [id])
  invitedAdmins     Admin[]                 @relation("AdminInviter")
  manager           Admin?                  @relation("ManagerSubordinates", fields: [managerId], references: [id])
  subordinates      Admin[]                 @relation("ManagerSubordinates")
  roleModel         RoleModel?              @relation("AdminRole", fields: [roleCode], references: [code])
  auditLogs         AdminAuditLog[]         @relation("AdminAuditLogs")
  notificationReads AdminNotificationRead[] @relation("AdminNotificationReads")
  sessions          AdminSession[]
  settings          AdminSettings?          @relation("AdminToSettings")
  twoFactorAuth     AdminTwoFactorAuth?
  auditLogsCreated  AuditLog[]
  mfaChallenges     MfaChallenge[]
  mfaEvents         MfaEvent[]              @relation("AdminMfaEvents")
  oneTimeTokens     OneTimeAuthToken[]      @relation("AdminOTAT")
  payInsApproved    PayIn[]                 @relation("PayInApprover")
  payInsInitiated   PayIn[]                 @relation("PayInInitiator")
  payOutsApproved   PayOut[]                @relation("PayOutApprover")
  payOutsInitiated  PayOut[]                @relation("PayOutInitiator")
  webAuthnCreds     WebAuthnCredential[]

  @@unique([ssoProvider, ssoSubject])
  @@index([workEmail])
  @@index([orgId])
  @@index([role])
  @@index([status])
  @@index([managerId])
  @@index([invitedBy])
  @@index([setupToken])
}

model RoleModel {
  code        String           @id @unique
  name        String
  description String?
  isSystem    Boolean          @default(false)
  isActive    Boolean          @default(true)
  priority    Int              @default(0)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  admins      Admin[]          @relation("AdminRole")
  permissions RolePermission[]

  @@index([isActive])
  @@map("Role_")
}

model Permission {
  code        String           @id @unique
  name        String
  resource    String
  action      String
  description String?
  category    String
  isSystem    Boolean          @default(false)
  createdAt   DateTime         @default(now())
  roles       RolePermission[]

  @@unique([resource, action])
  @@index([resource])
  @@index([category])
}

model RolePermission {
  id             String     @id @default(cuid())
  roleCode       String
  permissionCode String
  createdAt      DateTime   @default(now())
  permission     Permission @relation(fields: [permissionCode], references: [code], onDelete: Cascade)
  role           RoleModel  @relation(fields: [roleCode], references: [code], onDelete: Cascade)

  @@unique([roleCode, permissionCode])
  @@index([roleCode])
  @@index([permissionCode])
}

model WebAuthnCredential {
  id           String    @id @default(cuid())
  adminId      String
  credentialId String    @unique
  publicKey    String
  counter      Int       @default(0)
  deviceName   String?
  deviceType   String?
  transports   String[]
  aaguid       String?
  attestation  String?
  isActive     Boolean   @default(true)
  lastUsed     DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  admin        Admin     @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([credentialId])
}

model AdminTwoFactorAuth {
  id               String    @id @default(cuid())
  adminId          String    @unique
  totpEnabled      Boolean   @default(false)
  totpSecret       String?
  totpVerifiedAt   DateTime?
  webAuthnEnabled  Boolean   @default(false)
  webAuthnRequired Boolean   @default(false)
  backupCodes      Json?
  preferredMethod  String    @default("TOTP")
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  admin            Admin     @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
}

model MfaChallenge {
  id            String             @id @default(cuid())
  adminId       String
  action        String
  resourceType  String?
  resourceId    String?
  challengeType String
  challenge     String
  status        MfaChallengeStatus @default(PENDING)
  attempts      Int                @default(0)
  maxAttempts   Int                @default(3)
  verifiedAt    DateTime?
  verifiedWith  String?
  expiresAt     DateTime
  createdAt     DateTime           @default(now())
  admin         Admin              @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId, status])
  @@index([expiresAt])
}

model AdminSession {
  id                String    @id @default(cuid())
  adminId           String
  sessionId         String    @unique
  sessionToken      String    @unique
  sessionKey        String
  ipAddress         String
  deviceType        String?
  browser           String?
  browserVersion    String?
  os                String?
  osVersion         String?
  userAgent         String
  country           String?
  city              String?
  mfaMethod         String?
  mfaVerifiedAt     DateTime?
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  lastActivity      DateTime  @default(now())
  expiresAt         DateTime
  idleTimeout       Int?
  maxDuration       Int?
  terminatedAt      DateTime?
  terminatedBy      String?
  terminationReason String?
  updatedAt         DateTime  @updatedAt
  admin             Admin     @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId, isActive])
  @@index([sessionId])
  @@index([sessionToken])
  @@index([sessionKey])
  @@index([lastActivity])
  @@index([expiresAt])
  @@index([ipAddress])
}

model BreakGlassUser {
  id                 String    @id @default(cuid())
  username           String    @unique
  passwordHash       String
  totpSecret         String
  isActive           Boolean   @default(false)
  lastUsed           DateTime?
  usageCount         Int       @default(0)
  accessInstructions String
  autoDisableAfter   Int       @default(24)
  createdAt          DateTime  @default(now())
}

model AuditLogEnhanced {
  id            String    @id @default(cuid())
  userId        String?
  userEmail     String?
  userRole      String?
  action        String
  entity        String
  entityId      String
  oldValue      Json?
  newValue      Json?
  changes       Json?
  metadata      Json?
  reason        String?
  ipAddress     String
  userAgent     String
  country       String?
  city          String?
  mfaRequired   Boolean   @default(false)
  mfaMethod     String?
  mfaVerifiedAt DateTime?
  severity      String    @default("INFO")
  isReviewable  Boolean   @default(false)
  reviewedAt    DateTime?
  reviewedBy    String?
  createdAt     DateTime  @default(now())
  hash          String?

  @@index([userId])
  @@index([entity, entityId])
  @@index([action])
  @@index([createdAt])
  @@index([severity])
  @@index([isReviewable])
  @@index([userRole])
  @@map("AuditLog_Enhanced")
}

model OneTimeAuthToken {
  id        String    @id @default(cuid())
  token     String    @unique
  adminId   String
  createdAt DateTime  @default(now())
  expiresAt DateTime
  usedAt    DateTime?
  usedFrom  String?
  admin     Admin     @relation("AdminOTAT", fields: [adminId], references: [id], onDelete: Cascade)

  @@index([token, expiresAt])
  @@index([adminId])
  @@map("OneTimeAuthToken")
}

model NotificationEventCategory {
  id          String                      @id @default(cuid())
  code        String                      @unique
  name        String
  description String?
  icon        String?
  color       String?
  parentId    String?
  isSystem    Boolean                     @default(false)
  isActive    Boolean                     @default(true)
  sortOrder   Int                         @default(0)
  createdAt   DateTime                    @default(now())
  updatedAt   DateTime                    @updatedAt
  createdBy   String?
  events      NotificationEvent[]         @relation("EventCategoryToEvent")
  parent      NotificationEventCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    NotificationEventCategory[] @relation("CategoryHierarchy")

  @@index([code])
  @@index([parentId])
  @@index([isActive])
  @@index([sortOrder])
}

model NotificationEvent {
  id                String                     @id @default(cuid())
  eventKey          String                     @unique
  name              String
  description       String?
  category          EventCategory              @default(SYSTEM)
  channels          NotificationChannel[]
  priority          EventPriority              @default(NORMAL)
  isActive          Boolean                    @default(true)
  isSystem          Boolean                    @default(false)
  templateKey       String?
  createdAt         DateTime                   @default(now())
  updatedAt         DateTime                   @updatedAt
  categoryId        String?
  developerNotes    String?
  examplePayload    Json?
  optionalVariables String[]                   @default([])
  requiredVariables String[]                   @default([])
  templateId        String?
  usageExamples     Json?
  variableSchema    Json?
  eventCategory     NotificationEventCategory? @relation("EventCategoryToEvent", fields: [categoryId], references: [id])
  emailTemplate     EmailTemplate?             @relation("EventEmailTemplate", fields: [templateId], references: [id])
  queue             NotificationQueue[]
  subscriptions     NotificationSubscription[]

  @@index([eventKey])
  @@index([category])
  @@index([isActive])
  @@index([templateId])
}

model NotificationQueue {
  id             String              @id @default(cuid())
  eventKey       String
  userId         String?
  recipientEmail String?
  recipientPhone String?
  channel        NotificationChannel
  subject        String?
  message        String
  data           Json
  templateKey    String?
  status         QueueStatus         @default(PENDING)
  attempts       Int                 @default(0)
  maxAttempts    Int                 @default(3)
  scheduledFor   DateTime            @default(now())
  processedAt    DateTime?
  sentAt         DateTime?
  failedAt       DateTime?
  messageId      String?
  error          String?
  errorDetails   Json?
  providerId     String?
  metadata       Json?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  event          NotificationEvent   @relation(fields: [eventKey], references: [eventKey])
  user           User?               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status, scheduledFor])
  @@index([userId])
  @@index([channel])
  @@index([eventKey])
  @@index([createdAt])
}

model NotificationHistory {
  id        String              @id @default(cuid())
  userId    String
  eventKey  String
  channel   NotificationChannel
  title     String
  message   String
  data      Json?
  isRead    Boolean             @default(false)
  readAt    DateTime?
  isClicked Boolean             @default(false)
  clickedAt DateTime?
  actionUrl String?
  createdAt DateTime            @default(now())
  user      User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@index([eventKey])
}

model NotificationSubscription {
  id           String                @id @default(cuid())
  userId       String
  eventKey     String
  emailEnabled Boolean               @default(true)
  inAppEnabled Boolean               @default(true)
  smsEnabled   Boolean               @default(false)
  pushEnabled  Boolean               @default(false)
  frequency    NotificationFrequency @default(INSTANT)
  quietHours   Json?
  isActive     Boolean               @default(true)
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  event        NotificationEvent     @relation(fields: [eventKey], references: [eventKey])
  user         User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, eventKey])
  @@index([userId])
  @@index([eventKey])
}

model EmailTemplate {
  id                 String              @id @default(cuid())
  orgId              String?
  key                String
  name               String
  description        String?
  category           EmailCategory
  subject            String
  htmlContent        String
  textContent        String?
  preheader          String?
  layout             String              @default("default")
  variables          Json
  metadata           Json?
  version            Int                 @default(1)
  isActive           Boolean             @default(true)
  isDefault          Boolean             @default(false)
  status             TemplateStatus      @default(DRAFT)
  publishedAt        DateTime?
  publishedBy        String?
  createdBy          String?
  updatedBy          String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  editorContent      Json?
  emailLogs          EmailLog[]          @relation("TemplateUsed")
  notificationEvents NotificationEvent[] @relation("EventEmailTemplate")

  @@unique([orgId, key, version])
  @@index([orgId, key])
  @@index([category])
  @@index([status])
  @@index([isActive])
}

enum Role {
  CLIENT
  ADMIN
}

enum KycStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

enum OrderStatus {
  PENDING
  PAYMENT_PENDING
  PAYMENT_RECEIVED
  PROCESSING
  COMPLETED
  CANCELLED
  EXPIRED
  REFUNDED
  FAILED
}

enum EmailStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  BOUNCED
}

enum SettingType {
  STRING
  NUMBER
  BOOLEAN
  JSON
}

enum PaymentAccountType {
  BANK_ACCOUNT
  CRYPTO_WALLET
}

enum PayInStatus {
  PENDING
  RECEIVED
  VERIFIED
  PARTIAL
  MISMATCH
  RECONCILED
  FAILED
  REFUNDED
  EXPIRED
}

enum PayOutStatus {
  PENDING
  QUEUED
  PROCESSING
  SENT
  CONFIRMING
  CONFIRMED
  FAILED
  CANCELLED
}

enum CurrencyType {
  FIAT
  CRYPTO
}

enum PaymentDirection {
  IN
  OUT
  BOTH
}

enum ProviderType {
  MANUAL
  BANK_ACCOUNT
  PSP
  CRYPTO_WALLET
}

enum AutomationLevel {
  MANUAL
  SEMI_AUTO
  FULLY_AUTO
}

enum DocumentCategory {
  PUBLIC
  INTERNAL
  LEGAL
}

enum DocumentStatus {
  DRAFT
  REVIEW
  PUBLISHED
  ARCHIVED
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  COMPLIANCE
  TREASURY_APPROVER
  FINANCE
  SUPPORT
  READ_ONLY
}

enum AdminStatus {
  INVITED
  ACTIVE
  SUSPENDED
  TERMINATED
}

enum AuthMethod {
  PASSWORD
  SSO
  PASSKEY
  HYBRID
}

enum MfaChallengeStatus {
  PENDING
  VERIFIED
  EXPIRED
  FAILED
}

enum EventCategory {
  ORDER
  KYC
  PAYMENT
  SECURITY
  SYSTEM
  ADMIN
  MARKETING
}

enum EventPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum NotificationChannel {
  EMAIL
  IN_APP
  SMS
  PUSH
}

enum QueueStatus {
  PENDING
  PROCESSING
  SENT
  FAILED
  CANCELLED
  SKIPPED
}

enum NotificationFrequency {
  INSTANT
  HOURLY
  DAILY
  WEEKLY
}

enum EmailCategory {
  TRANSACTIONAL
  NOTIFICATION
  MARKETING
  SYSTEM
  COMPLIANCE
}

enum TemplateStatus {
  DRAFT
  REVIEW
  PUBLISHED
  ARCHIVED
}

// ============================================================================
// WEBHOOKS SYSTEM
// ============================================================================

model Webhook {
  id          String             @id @default(cuid())
  apiKeyId    String
  url         String
  secret      String // HMAC secret for signature verification
  events      String[] // Array of event types (e.g., ["order.created", "order.completed"])
  isActive    Boolean            @default(true)
  description String?
  headers     Json? // Custom headers to include
  retryCount  Int                @default(3)
  timeout     Int                @default(30000) // milliseconds
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  apiKey      ApiKey             @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)
  deliveries  WebhookDelivery[]

  @@index([apiKeyId])
  @@index([isActive])
}

model WebhookDelivery {
  id               String                @id @default(cuid())
  webhookId        String
  event            String // Event type (e.g., "order.created")
  payload          Json // Event payload
  signature        String // HMAC signature
  status           WebhookDeliveryStatus @default(PENDING)
  attempts         Int                   @default(0)
  maxAttempts      Int                   @default(3)
  lastAttemptAt    DateTime?
  nextAttemptAt    DateTime?
  responseStatus   Int? // HTTP status code
  responseBody     String? // Response body (truncated)
  responseTime     Int? // Response time in ms
  errorMessage     String?
  deliveredAt      DateTime?
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  webhook          Webhook               @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([status])
  @@index([event])
  @@index([createdAt])
  @@index([nextAttemptAt])
}

enum WebhookDeliveryStatus {
  PENDING
  PROCESSING
  DELIVERED
  FAILED
  CANCELLED
}
