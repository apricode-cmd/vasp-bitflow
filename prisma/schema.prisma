generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                   String              @id @default(cuid())
  email                String              @unique
  password             String
  role                 Role                @default(CLIENT)
  isActive             Boolean             @default(true)
  lastLogin            DateTime?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  
  adminSettings        AdminSettings?      @relation("AdminSettings")
  apiKeys              ApiKey[]
  
  // Audit Logs
  userAuditLogs        UserAuditLog[]      @relation("UserAuditLogs") // NEW: отдельная таблица для клиентов
  auditLogs            AuditLog[]          // LEGACY: старая таблица
  
  emailLogs            EmailLog[]
  blockedIPs           IPBlacklist[]       @relation("BlockedBy")
  kycSession           KycSession?
  orders               Order[]
  payInsReconciled     PayIn[]             @relation("PayInReconciler")
  payInsAsUser         PayIn[]             @relation("PayInUser")
  payInsVerified       PayIn[]             @relation("PayInVerifier")
  payOutsProcessed     PayOut[]            @relation("PayOutProcessor")
  payOutsAsUser        PayOut[]            @relation("PayOutUser")
  paymentProofs        PaymentProof[]
  profile              Profile?
  sessionRevocationsBy SessionRevocation[] @relation("RevokedBy")
  revokedSessions      SessionRevocation[] @relation("RevokedSessions")
  twoFactorAuth        TwoFactorAuth?
  kycLevelData         UserKycLevel?       @relation("UserKycLevelRelation")
  userWallets          UserWallet[]
  
  // Notification System
  notificationQueue         NotificationQueue[]
  notificationHistory       NotificationHistory[]
  notificationSubscriptions NotificationSubscription[]

  @@index([email])
  @@index([role])
}

model Profile {
  id           String    @id @default(cuid())
  userId       String    @unique
  firstName    String
  lastName     String
  phoneNumber  String?
  country      String
  city         String?
  address      String?
  postalCode   String?
  dateOfBirth  DateTime?
  nationality  String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  phoneCountry String?
  placeOfBirth String?
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([country])
}

model KycSession {
  id                   String        @id @default(cuid())
  userId               String        @unique
  
  // Universal fields (work with any KYC provider)
  kycProviderId        String?
  applicantId          String?       // Universal applicant ID (replaces kycaidApplicantId)
  verificationId       String?       @unique // Universal verification ID (replaces kycaidVerificationId)
  
  // Legacy KYCAID-specific fields (deprecated, use universal fields above)
  kycaidVerificationId String?       @unique
  kycaidApplicantId    String?
  kycaidFormId         String?
  
  status               KycStatus     @default(PENDING)
  submittedAt          DateTime?
  reviewedAt           DateTime?
  reviewedBy           String?
  reviewNotes          String?
  completedAt          DateTime?
  expiresAt            DateTime?
  rejectionReason      String?
  webhookData          Json?
  metadata             Json?
  attempts             Int           @default(0)
  lastAttemptAt        DateTime?
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  
  documents            KycDocument[]
  formData             KycFormData[]
  profile              KycProfile?
  user                 User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([kycaidVerificationId])
  @@index([kycProviderId])
  @@index([applicantId])
  @@index([verificationId])
}

model Currency {
  code               String                      @id
  name               String
  symbol             String
  decimals           Int                         @default(8)
  precision          Int                         @default(8)
  coingeckoId        String
  isActive           Boolean                     @default(true)
  priority           Int                         @default(0)
  isToken            Boolean                     @default(false)
  iconUrl            String?
  minOrderAmount     Float                       @default(0.001)
  maxOrderAmount     Float                       @default(100)
  createdAt          DateTime                    @default(now())
  updatedAt          DateTime                    @updatedAt
  blockchainNetworks CurrencyBlockchainNetwork[]
  orders             Order[]
  payIns             PayIn[]                     @relation("PayInCrypto")
  payOuts            PayOut[]
  paymentAccounts    PaymentAccount[]            @relation("PaymentAccountCrypto")
  platformWallets    PlatformWallet[]
  rateHistory        RateHistory[]               @relation("CryptoCurrency")
  tradingPairs       TradingPair[]               @relation("CryptoCurrency")
  userWallets        UserWallet[]

  @@index([isToken])
}

model FiatCurrency {
  code            String           @id
  name            String
  symbol          String
  precision       Int              @default(2)
  isActive        Boolean          @default(true)
  priority        Int              @default(0)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  bankDetails     BankDetails[]
  feeProfiles     FeeProfile[]
  limitsMatrix    LimitsMatrix[]
  orders          Order[]
  payIns          PayIn[]
  payOuts         PayOut[]         @relation("PayOutFiat")
  paymentAccounts PaymentAccount[]
  rateHistory     RateHistory[]    @relation("FiatCurrency")
  tradingPairs    TradingPair[]    @relation("FiatCurrency")
}

model TradingPair {
  id              String       @id @default(cuid())
  cryptoCode      String
  fiatCode        String
  isActive        Boolean      @default(true)
  minCryptoAmount Float
  maxCryptoAmount Float
  minFiatAmount   Float
  maxFiatAmount   Float
  feePercent      Float        @default(1.5)
  priority        Int          @default(0)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  crypto          Currency     @relation("CryptoCurrency", fields: [cryptoCode], references: [code])
  fiat            FiatCurrency @relation("FiatCurrency", fields: [fiatCode], references: [code])

  @@unique([cryptoCode, fiatCode])
  @@index([isActive])
}

model RateHistory {
  id         String       @id @default(cuid())
  cryptoCode String
  fiatCode   String
  rate       Float
  source     String       @default("coingecko")
  createdAt  DateTime     @default(now())
  crypto     Currency     @relation("CryptoCurrency", fields: [cryptoCode], references: [code])
  fiat       FiatCurrency @relation("FiatCurrency", fields: [fiatCode], references: [code])

  @@index([cryptoCode, fiatCode, createdAt])
}

model Order {
  id                String               @id @default(cuid())
  userId            String
  currencyCode      String
  fiatCurrencyCode  String
  paymentReference  String               @unique
  cryptoAmount      Float
  fiatAmount        Float
  rate              Float
  feePercent        Float
  feeAmount         Float
  totalFiat         Float
  userWalletId      String?
  walletAddress     String
  blockchainCode    String?
  paymentMethodCode String?
  status            OrderStatus          @default(PENDING)
  createdByAdmin    Boolean              @default(false)
  adminNotes        String?
  transactionHash   String?
  processedBy       String?
  processedAt       DateTime?
  expiresAt         DateTime
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  blockchain        BlockchainNetwork?   @relation(fields: [blockchainCode], references: [code])
  currency          Currency             @relation(fields: [currencyCode], references: [code])
  fiatCurrency      FiatCurrency         @relation(fields: [fiatCurrencyCode], references: [code])
  paymentMethod     PaymentMethod?       @relation(fields: [paymentMethodCode], references: [code])
  user              User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  userWallet        UserWallet?          @relation(fields: [userWalletId], references: [id])
  statusHistory     OrderStatusHistory[]
  payIn             PayIn?
  payOut            PayOut?
  paymentProofs     PaymentProof[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([paymentReference])
  @@index([userWalletId])
  @@index([blockchainCode])
}

model PaymentProof {
  id         String   @id @default(cuid())
  orderId    String
  fileUrl    String
  fileName   String
  fileSize   Int
  mimeType   String
  uploadedBy String
  uploadedAt DateTime @default(now())
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [uploadedBy], references: [id])

  @@index([orderId])
}

model PaymentAccount {
  id                 String             @id @default(cuid())
  code               String             @unique
  name               String
  type               PaymentAccountType
  description        String?
  currency           String?
  bankName           String?
  bankAddress        String?
  accountHolder      String?
  iban               String?
  swift              String?
  bic                String?
  sortCode           String?
  referenceTemplate  String?
  cryptocurrencyCode String?
  blockchainCode     String?
  address            String?
  balance            Float?
  minBalance         Float?
  instructions       String?
  isActive           Boolean            @default(true)
  isDefault          Boolean            @default(false)
  priority           Int                @default(0)
  lastUsed           DateTime?
  lastChecked        DateTime?
  alertsEnabled      Boolean            @default(true)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  createdBy          String?
  payOuts            PayOut[]           @relation("PaymentAccountPayOuts")
  blockchain         BlockchainNetwork? @relation(fields: [blockchainCode], references: [code])
  cryptocurrency     Currency?          @relation("PaymentAccountCrypto", fields: [cryptocurrencyCode], references: [code])
  fiatCurrency       FiatCurrency?      @relation(fields: [currency], references: [code])
  paymentMethods     PaymentMethod[]

  @@index([type, isActive])
  @@index([currency])
  @@index([cryptocurrencyCode])
  @@index([isDefault])
}

model BankDetails {
  id                String          @id @default(cuid())
  currency          String
  bankName          String
  bankAddress       String?
  accountHolder     String
  iban              String
  swift             String?
  bic               String?
  sortCode          String?
  referenceTemplate String          @default("APR-{orderId}")
  instructions      String?
  isActive          Boolean         @default(true)
  priority          Int             @default(0)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  fiatCurrency      FiatCurrency    @relation(fields: [currency], references: [code])
  paymentMethods    PaymentMethod[]

  @@index([currency, isActive])
}

model PlatformWallet {
  id             String            @id @default(cuid())
  currencyCode   String
  blockchainCode String
  address        String            @unique
  label          String
  isActive       Boolean           @default(true)
  balance        Float             @default(0)
  lastUsed       DateTime?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  payOuts        PayOut[]
  blockchain     BlockchainNetwork @relation(fields: [blockchainCode], references: [code])
  currency       Currency          @relation(fields: [currencyCode], references: [code])

  @@index([currencyCode, isActive])
}

model PayIn {
  id                 String       @id @default(cuid())
  orderId            String       @unique
  userId             String
  amount             Float
  fiatCurrencyCode   String?
  cryptocurrencyCode String?
  currencyType       CurrencyType
  paymentMethodCode  String?
  senderName         String?
  senderAccount      String?
  senderBank         String?
  reference          String?
  networkCode        String?
  senderAddress      String?
  transactionHash    String?
  blockNumber        Int?
  confirmations      Int          @default(0)
  transactionId      String?      @unique
  status             PayInStatus  @default(PENDING)
  expectedAmount     Float
  receivedAmount     Float?
  amountMismatch     Boolean      @default(false)

  // Separation of Duties (SoD) - 4-eyes principle
  initiatedBy      String? // Admin ID who initiated
  initiatedAt      DateTime?
  approvedBy       String? // Admin ID who approved (must be different from initiatedBy)
  approvedAt       DateTime?
  approvalRequired Boolean   @default(true) // Requires approval for large amounts

  verifiedBy        String?
  verifiedAt        DateTime?
  verificationNotes String?
  reconciledWith    String?
  reconciledAt      DateTime?
  reconciledBy      String?
  proofUrls         String[]
  explorerUrl       String?
  paymentDate       DateTime?
  receivedDate      DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  cryptocurrency    Currency?          @relation("PayInCrypto", fields: [cryptocurrencyCode], references: [code])
  fiatCurrency      FiatCurrency?      @relation(fields: [fiatCurrencyCode], references: [code])
  network           BlockchainNetwork? @relation("PayInNetwork", fields: [networkCode], references: [code])
  order             Order              @relation(fields: [orderId], references: [id], onDelete: Cascade)
  paymentMethod     PaymentMethod?     @relation(fields: [paymentMethodCode], references: [code])
  reconciler        User?              @relation("PayInReconciler", fields: [reconciledBy], references: [id])
  user              User               @relation("PayInUser", fields: [userId], references: [id], onDelete: Cascade)
  verifier          User?              @relation("PayInVerifier", fields: [verifiedBy], references: [id])

  // SoD Relations to Admin
  initiator Admin? @relation("PayInInitiator", fields: [initiatedBy], references: [id])
  approver  Admin? @relation("PayInApprover", fields: [approvedBy], references: [id])

  @@index([orderId])
  @@index([userId])
  @@index([fiatCurrencyCode])
  @@index([cryptocurrencyCode])
  @@index([status])
  @@index([currencyType])
  @@index([paymentDate])
  @@index([transactionId])
  @@index([transactionHash])
  @@index([createdAt])
}

model PayOut {
  id                 String       @id @default(cuid())
  orderId            String       @unique
  userId             String
  amount             Float
  fiatCurrencyCode   String?
  cryptocurrencyCode String?
  currencyType       CurrencyType
  networkCode        String?
  destinationAddress String?
  destinationTag     String?
  userWalletId       String?
  transactionHash    String?      @unique
  explorerUrl        String?
  blockNumber        Int?
  confirmations      Int          @default(0)
  networkFee         Float?
  networkFeeCurrency String?
  recipientName      String?
  recipientAccount   String?
  recipientBank      String?
  paymentReference   String?
  bankTransactionId  String?
  paymentMethodCode  String?
  status             PayOutStatus @default(PENDING)
  failureReason      String?
  retryCount         Int          @default(0)

  // Separation of Duties (SoD) - 4-eyes principle for payouts
  initiatedBy       String? // Admin ID who initiated payout
  initiatedAt       DateTime?
  approvedBy        String? // Admin ID who approved (MUST be different from initiatedBy)
  approvedAt        DateTime?
  approvalRequired  Boolean   @default(true) // Requires approval (based on amount threshold)
  requiresStepUpMfa Boolean   @default(false) // Approval requires step-up MFA

  processedBy      String?
  processedAt      DateTime?
  processingNotes  String?
  paymentAccountId String?
  fromWalletId     String?
  scheduledFor     DateTime?
  sentAt           DateTime?
  confirmedAt      DateTime?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  cryptocurrency   Currency?          @relation(fields: [cryptocurrencyCode], references: [code])
  fiatCurrency     FiatCurrency?      @relation("PayOutFiat", fields: [fiatCurrencyCode], references: [code])
  platformWallet   PlatformWallet?    @relation(fields: [fromWalletId], references: [id])
  network          BlockchainNetwork? @relation(fields: [networkCode], references: [code])
  order            Order              @relation(fields: [orderId], references: [id], onDelete: Cascade)
  paymentAccount   PaymentAccount?    @relation("PaymentAccountPayOuts", fields: [paymentAccountId], references: [id])
  paymentMethod    PaymentMethod?     @relation("PayOutMethod", fields: [paymentMethodCode], references: [code])
  processor        User?              @relation("PayOutProcessor", fields: [processedBy], references: [id])
  user             User               @relation("PayOutUser", fields: [userId], references: [id])

  // SoD Relations to Admin
  initiator  Admin?      @relation("PayOutInitiator", fields: [initiatedBy], references: [id])
  approver   Admin?      @relation("PayOutApprover", fields: [approvedBy], references: [id])
  userWallet UserWallet? @relation(fields: [userWalletId], references: [id])

  @@index([orderId])
  @@index([userId])
  @@index([fiatCurrencyCode])
  @@index([cryptocurrencyCode])
  @@index([status])
  @@index([transactionHash])
  @@index([destinationAddress])
  @@index([currencyType])
  @@index([scheduledFor])
  @@index([createdAt])
}

// Admin Audit Log - только действия администраторов
model AdminAuditLog {
  id String @id @default(cuid())

  // Organization
  orgId String?

  // Actor (Admin)
  adminId    String
  adminEmail String? // Snapshot
  adminRole  String? // Snapshot

  // Action
  action     String
  entityType String
  entityId   String

  // Changes (diff)
  diffBefore Json?
  diffAfter  Json?
  changes    Json? // Detailed diff

  // Context
  context Json? // { ip, ua, device, location, risk, etc }
  reason  String? // For critical actions

  // MFA verification
  mfaRequired   Boolean   @default(false)
  mfaMethod     String?
  mfaVerifiedAt DateTime?
  mfaEventId    String? // Link to MfaEvent

  // Compliance
  severity     String  @default("INFO") // INFO, WARNING, CRITICAL
  isReviewable Boolean @default(false)
  reviewedAt   DateTime?
  reviewedBy   String?
  reviewNotes  String?

  // Immutability
  createdAt      DateTime @default(now())
  freezeChecksum String? // SHA-256 for integrity

  // Relations
  admin    Admin     @relation("AdminAuditLogs", fields: [adminId], references: [id], onDelete: Cascade)
  mfaEvent MfaEvent? @relation("AdminMfaLogs", fields: [mfaEventId], references: [id], onDelete: SetNull)

  @@index([orgId, createdAt(sort: Desc)])
  @@index([adminId, createdAt(sort: Desc)])
  @@index([entityType, entityId])
  @@index([action])
  @@index([severity])
  @@index([isReviewable])
  @@index([mfaEventId])
}

// User Audit Log - только действия клиентов
model UserAuditLog {
  id String @id @default(cuid())

  // Organization
  orgId String?

  // Actor (User/Client)
  userId    String
  userEmail String? // Snapshot
  userRole  String? // Snapshot (CLIENT)

  // Action
  action     String
  entityType String
  entityId   String

  // Changes (diff)
  diffBefore Json?
  diffAfter  Json?
  changes    Json?

  // Context
  context Json? // { ip, ua, device, location, risk, etc }

  // MFA verification
  mfaRequired   Boolean   @default(false)
  mfaMethod     String?
  mfaVerifiedAt DateTime?
  mfaEventId    String?

  // Timestamps
  createdAt      DateTime @default(now())
  freezeChecksum String?

  // Relations
  user     User      @relation("UserAuditLogs", fields: [userId], references: [id], onDelete: Cascade)
  mfaEvent MfaEvent? @relation("UserMfaLogs", fields: [mfaEventId], references: [id], onDelete: SetNull)

  @@index([orgId, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@index([entityType, entityId])
  @@index([action])
  @@index([mfaEventId])
}

// Legacy AuditLog (keep for backward compatibility, will be removed later)
model AuditLog {
  id String @id @default(cuid())

  // Organization (for multi-tenancy)
  orgId String?

  // Actor (unified for User and Admin)
  actorType  String?  // 'USER' | 'ADMIN' | 'SYSTEM' (nullable for legacy data)
  actorId    String? // userId OR adminId (universal)
  actorRole  String? // Role snapshot
  actorEmail String? // Email snapshot

  // Legacy fields (deprecated, use actorType/actorId instead)
  userId    String? // DEPRECATED: use actorId with actorType='USER'
  adminId   String? // DEPRECATED: use actorId with actorType='ADMIN'
  userEmail String? // DEPRECATED: use actorEmail
  userRole  String? // DEPRECATED: use actorRole

  // What (Action)
  action     String
  entity     String  // DEPRECATED: use entityType
  entityType String? // New: clearer naming
  entityId   String

  // Changes (diff)
  oldValue   Json? // DEPRECATED: use diffBefore
  newValue   Json? // DEPRECATED: use diffAfter
  diffBefore Json? // New: before state
  diffAfter  Json? // New: after state
  changes    Json? // Detailed diff

  // Context (consolidated)
  context  Json? // New: { ip, ua, device, location, risk, etc }
  metadata Json? // Additional metadata
  reason   String? // For critical actions

  // Legacy context fields (deprecated)
  ipAddress String?
  userAgent String?
  country   String?
  city      String?

  // MFA verification
  mfaRequired   Boolean   @default(false)
  mfaMethod     String?
  mfaVerifiedAt DateTime?
  mfaEventId    String? // Link to MfaEvent table

  // Compliance
  severity     String  @default("INFO") // INFO, WARNING, CRITICAL
  isReviewable Boolean @default(false)
  reviewedAt   DateTime?
  reviewedBy   String?

  // Immutability
  createdAt      DateTime @default(now())
  hash           String? // DEPRECATED: use freezeChecksum
  freezeChecksum String? // New: SHA-256 for integrity

  // Relations
  user     User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  admin    Admin?    @relation(fields: [adminId], references: [id], onDelete: SetNull)
  mfaEvent MfaEvent? @relation("LegacyMfaLogs", fields: [mfaEventId], references: [id], onDelete: SetNull)

  @@index([orgId, createdAt(sort: Desc)])
  @@index([actorType, actorId])
  @@index([userId]) // Legacy
  @@index([adminId]) // Legacy
  @@index([entity, entityId]) // Legacy
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
  @@index([severity])
  @@index([isReviewable])
  @@index([userRole]) // Legacy
  @@index([mfaEventId])
}

// MFA Events - общая таблица для User и Admin
model MfaEvent {
  id String @id @default(cuid())

  // Organization
  orgId String?

  // Actor
  actorId   String
  actorType String // 'USER' | 'ADMIN'
  actorRole String?

  // Event details
  actionType String // 'STEPUP' | 'LOGIN' | 'REGISTER'
  method     String // 'WEBAUTHN' | 'TOTP' | 'BACKUP_CODE'

  // WebAuthn specific
  userVerification Boolean? // UV flag
  credentialIdHash String? // Hashed credential ID (not full ID!)
  aaguid           String? // Authenticator AAGUID
  signCount        Int? // Signature counter

  // Challenge
  challengeId String?

  // Result
  result       String // 'SUCCESS' | 'FAILED' | 'EXPIRED'
  errorCode    String?
  errorMessage String?

  // Context
  ipAddress  String
  userAgent  String?
  deviceInfo Json? // Browser, OS, device type

  // Timestamps
  createdAt DateTime @default(now())

  // Relations
  admin          Admin?           @relation("AdminMfaEvents", fields: [actorId], references: [id], onDelete: SetNull)
  adminAuditLogs AdminAuditLog[]  @relation("AdminMfaLogs")
  userAuditLogs  UserAuditLog[]   @relation("UserMfaLogs")
  legacyLogs     AuditLog[]       @relation("LegacyMfaLogs")

  @@index([actorId, createdAt(sort: Desc)])
  @@index([orgId, createdAt(sort: Desc)])
  @@index([challengeId])
  @@index([result])
  @@index([actionType])
}

// System Logs - технические события
model SystemLog {
  id String @id @default(cuid())

  // Organization
  orgId String?

  // Source
  source String? // 'KYCAID_WEBHOOK' | 'RAPYD_WEBHOOK' | 'TATUM_API' | 'NODE' (nullable for legacy)
  level  String? // 'INFO' | 'WARN' | 'ERROR' | 'CRITICAL' (nullable for legacy)

  // Event details
  eventType   String? // 'WEBHOOK_RECEIVED' | 'API_CALL' | 'INTEGRATION_SYNC' (nullable for legacy)
  endpoint    String?
  method      String?
  statusCode  Int?

  // Payload (sanitized - no secrets!)
  payload      Json?
  requestBody  Json?
  responseBody Json?

  // Error details
  errorMessage String?
  errorStack   String? @db.Text

  // Performance
  responseTime Int? // milliseconds

  // Context
  metadata Json?

  // Timestamps
  createdAt DateTime @default(now())

  @@index([source, createdAt(sort: Desc)])
  @@index([level, createdAt(sort: Desc)])
  @@index([orgId, createdAt(sort: Desc)])
  @@index([eventType])
}

model EmailLog {
  id          String      @id @default(cuid())
  userId      String?
  recipient   String
  subject     String
  template    String      // Template key (e.g., 'ORDER_CREATED')
  status      EmailStatus @default(PENDING)
  sentAt      DateTime?
  deliveredAt DateTime?
  failedAt    DateTime?
  error       String?
  metadata    Json?
  createdAt   DateTime    @default(now())
  
  // Relations
  user            User?          @relation(fields: [userId], references: [id])
  emailTemplate   EmailTemplate? @relation("TemplateUsed", fields: [templateId], references: [id])
  templateId      String?

  @@index([userId])
  @@index([status])
  @@index([template])
  @@index([templateId])
  @@index([createdAt])
}

model SystemSettings {
  key         String      @id
  value       String
  type        SettingType @default(STRING)
  category    String      @default("general")
  description String?
  isPublic    Boolean     @default(false)
  updatedAt   DateTime    @updatedAt
  updatedBy   String?

  @@index([category])
  @@index([isPublic])
}

model BlockchainNetwork {
  id               String                      @id @default(cuid())
  code             String                      @unique
  name             String
  symbol           String?
  nativeToken      String
  nativeAsset      String?
  explorerUrl      String
  rpcUrl           String?
  chainId          Int?
  minConfirmations Int                         @default(12)
  confirmations    Int                         @default(12)
  isActive         Boolean                     @default(true)
  priority         Int                         @default(0)
  metadata         Json?
  createdAt        DateTime                    @default(now())
  updatedAt        DateTime                    @updatedAt
  currencies       CurrencyBlockchainNetwork[]
  orders           Order[]
  payIns           PayIn[]                     @relation("PayInNetwork")
  payOuts          PayOut[]
  paymentAccounts  PaymentAccount[]
  platformWallets  PlatformWallet[]
  transactions     Transaction[]
  userWallets      UserWallet[]

  @@index([isActive])
}

model CurrencyBlockchainNetwork {
  id              String            @id @default(cuid())
  currencyCode    String
  blockchainCode  String
  contractAddress String?
  isNative        Boolean           @default(false)
  isActive        Boolean           @default(true)
  priority        Int               @default(0)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  blockchain      BlockchainNetwork @relation(fields: [blockchainCode], references: [code], onDelete: Cascade)
  currency        Currency          @relation(fields: [currencyCode], references: [code], onDelete: Cascade)

  @@unique([currencyCode, blockchainCode])
  @@index([currencyCode])
  @@index([blockchainCode])
  @@index([isActive])
}

model UserWallet {
  id             String            @id @default(cuid())
  userId         String
  blockchainCode String
  currencyCode   String
  address        String
  label          String?
  isVerified     Boolean           @default(false)
  isDefault      Boolean           @default(false)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  orders         Order[]
  payOuts        PayOut[]
  blockchain     BlockchainNetwork @relation(fields: [blockchainCode], references: [code])
  currency       Currency          @relation(fields: [currencyCode], references: [code])
  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, address])
  @@index([userId, currencyCode])
  @@index([address])
}

model OrderStatusHistory {
  id        String      @id @default(cuid())
  orderId   String
  oldStatus OrderStatus
  newStatus OrderStatus
  changedBy String
  note      String?
  createdAt DateTime    @default(now())
  order     Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([createdAt])
}

model KycFormField {
  id         String   @id @default(cuid())
  fieldName  String   @unique
  label      String
  fieldType  String
  isRequired Boolean  @default(true)
  isEnabled  Boolean  @default(true)
  category   String
  validation Json?
  options    Json?
  priority   Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([category])
  @@index([isEnabled])
}

model KycDocument {
  id               String     @id @default(cuid())
  kycSessionId     String
  documentType     String
  fileUrl          String
  fileName         String
  fileSize         Int
  mimeType         String
  verifiedByAI     Boolean    @default(false)
  verificationData Json?
  uploadedAt       DateTime   @default(now())
  kycSession       KycSession @relation(fields: [kycSessionId], references: [id], onDelete: Cascade)

  @@index([kycSessionId])
  @@index([documentType])
}

model KycFormData {
  id           String     @id @default(cuid())
  kycSessionId String
  fieldName    String
  fieldValue   String
  createdAt    DateTime   @default(now())
  kycSession   KycSession @relation(fields: [kycSessionId], references: [id], onDelete: Cascade)

  @@unique([kycSessionId, fieldName])
  @@index([kycSessionId])
}

model PaymentMethod {
  code                  String           @id @unique
  name                  String
  description           String?
  type                  String
  direction             PaymentDirection @default(IN)
  providerType          ProviderType     @default(MANUAL)
  automationLevel       AutomationLevel  @default(MANUAL)
  currency              String
  supportedNetworks     String[]         @default([])
  pspConnector          String?
  paymentAccountId      String?
  bankAccountId         String?
  minAmount             Float?
  maxAmount             Float?
  feeFixed              Float            @default(0)
  feePercent            Float            @default(0)
  processingTime        String?
  instructions          String?
  iconUrl               String?
  priority              Int              @default(0)
  config                Json?
  isActive              Boolean          @default(true)
  isAvailableForClients Boolean          @default(true)
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  createdBy             String?
  limitsMatrix          LimitsMatrix[]
  orders                Order[]
  payIns                PayIn[]
  payOuts               PayOut[]         @relation("PayOutMethod")
  bankAccount           BankDetails?     @relation(fields: [bankAccountId], references: [id])
  paymentAccount        PaymentAccount?  @relation(fields: [paymentAccountId], references: [id])
  psp                   PspConnector?    @relation(fields: [pspConnector], references: [code])

  @@index([type, isActive])
  @@index([currency])
  @@index([direction])
  @@index([providerType])
  @@index([automationLevel])
  @@index([isAvailableForClients])
}

model ManualRate {
  id         String    @id @default(cuid())
  cryptoCode String
  fiatCode   String
  rate       Float
  validFrom  DateTime  @default(now())
  validTo    DateTime?
  isActive   Boolean   @default(true)
  createdBy  String
  reason     String?
  createdAt  DateTime  @default(now())

  @@index([cryptoCode, fiatCode, isActive])
  @@index([validFrom, validTo])
}

model IntegrationSetting {
  id         String    @id @default(cuid())
  service    String    @unique
  isEnabled  Boolean   @default(true)
  config     Json
  lastTested DateTime?
  status     String    @default("unconfigured")
  errorLog   String?
  updatedAt  DateTime  @updatedAt
  updatedBy  String?

  @@index([service])
  @@index([status])
}

model ApiKey {
  id          String        @id @default(cuid())
  userId      String?
  key         String
  keyHash     String        @unique
  name        String
  prefix      String
  permissions Json
  isActive    Boolean       @default(true)
  expiresAt   DateTime?
  lastUsedAt  DateTime?
  lastUsedIp  String?
  usageCount  Int           @default(0)
  rateLimit   Int           @default(100)
  createdBy   String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  user        User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  usage       ApiKeyUsage[]

  @@index([keyHash])
  @@index([userId])
  @@index([isActive])
  @@index([prefix])
}

model ApiKeyUsage {
  id           String   @id @default(cuid())
  apiKeyId     String
  endpoint     String
  method       String
  statusCode   Int
  responseTime Int
  ipAddress    String
  userAgent    String?
  errorMessage String?
  createdAt    DateTime @default(now())
  apiKey       ApiKey   @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)

  @@index([apiKeyId, createdAt])
  @@index([endpoint])
  @@index([createdAt])
}

model IpRule {
  id        String    @id @default(cuid())
  ipAddress String    @unique
  type      String
  reason    String?
  createdBy String
  createdAt DateTime  @default(now())
  expiresAt DateTime?

  @@index([ipAddress, type])
  @@index([type])
}

model TwoFactorAuth {
  id              String    @id @default(cuid())
  userId          String    @unique
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  passkeys        Json?
  passkeysEnabled Boolean   @default(false)
  totpEnabled     Boolean   @default(false)
  totpSecret      String?
  totpVerifiedAt  DateTime?
  backupCodes     Json?
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model DataRetentionPolicy {
  id            String   @id @default(cuid())
  entityType    String   @unique
  retentionDays Int
  autoDelete    Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model RateProvider {
  code          String         @id @unique
  name          String
  type          String
  weight        Float          @default(1.0)
  isActive      Boolean        @default(true)
  apiConfig     Json?
  priority      Int            @default(0)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  rateSnapshots RateSnapshot[]

  @@index([isActive])
  @@index([type])
}

model RateSnapshot {
  id         String       @id @default(cuid())
  providerId String
  assetCode  String
  fiatCode   String
  rate       Float
  timestamp  DateTime     @default(now())
  provider   RateProvider @relation(fields: [providerId], references: [code])

  @@index([assetCode, fiatCode, timestamp])
  @@index([providerId, timestamp])
}

model FeeProfile {
  code              String        @id @unique
  name              String
  spreadBps         Int
  fixedFeeFiat      Float         @default(0)
  fiatCurrency      String?
  networkFeePolicy  String        @default("pass-through")
  networkFeeAmount  Float?
  networkFeePercent Float?
  isActive          Boolean       @default(true)
  priority          Int           @default(0)
  description       String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  fiat              FiatCurrency? @relation(fields: [fiatCurrency], references: [code])

  @@index([isActive])
}

model KycLevel {
  code         String         @id @unique
  name         String
  description  String?
  allowMethods String[]
  requirements Json?
  dailyLimit   Float?
  monthlyLimit Float?
  isActive     Boolean        @default(true)
  priority     Int            @default(0)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  limitsMatrix LimitsMatrix[]

  @@index([isActive])
}

model LimitsMatrix {
  id            String        @id @default(cuid())
  kycLevel      String
  paymentMethod String
  fiatCurrency  String
  period        String
  limitAmount   Float
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  fiatRel       FiatCurrency  @relation(fields: [fiatCurrency], references: [code])
  kycLevelRel   KycLevel      @relation(fields: [kycLevel], references: [code])
  paymentRel    PaymentMethod @relation(fields: [paymentMethod], references: [code])

  @@unique([kycLevel, paymentMethod, fiatCurrency, period])
  @@index([kycLevel])
  @@index([paymentMethod])
}

model PspConnector {
  code               String          @id @unique
  name               String
  capabilities       String[]
  settlementCurrency String
  apiConfig          Json?
  isEnabled          Boolean         @default(true)
  lastTested         DateTime?
  status             String          @default("unconfigured")
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  paymentMethods     PaymentMethod[]

  @@index([isEnabled])
  @@index([status])
}

model OrderStatusConfig {
  code         String   @id @unique
  name         String
  description  String?
  color        String   @default("#6b7280")
  isTerminal   Boolean  @default(false)
  priority     Int      @default(0)
  nextStatuses String[] @default([])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([priority])
}

model TransactionStatusConfig {
  code        String   @id @unique
  name        String
  description String?
  color       String   @default("#6b7280")
  isTerminal  Boolean  @default(false)
  priority    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([priority])
}

model Transaction {
  id            String            @id @default(cuid())
  orderId       String?
  walletId      String?
  txHash        String?           @unique
  currencyCode  String
  chainCode     String
  amount        Float
  fee           Float?
  statusCode    String
  confirmations Int               @default(0)
  broadcastAt   DateTime?
  confirmedAt   DateTime?
  failedAt      DateTime?
  errorMessage  String?
  metadata      Json?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  chain         BlockchainNetwork @relation(fields: [chainCode], references: [code])

  @@index([orderId])
  @@index([txHash])
  @@index([statusCode])
  @@index([chainCode])
}

model WidgetConfig {
  id               String   @id @default(cuid())
  code             String   @unique
  name             String
  supportedPairs   String[]
  defaultFiat      String
  defaultCrypto    String?
  theme            Json
  minKycForMethods Json
  allowedMethods   String[]
  feeProfileCode   String?
  isActive         Boolean  @default(true)
  domain           String?
  webhookUrl       String?
  apiKey           String?
  metadata         Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([code])
  @@index([isActive])
}

model UserKycLevel {
  userId    String   @unique
  kycLevel  String
  updatedAt DateTime @updatedAt
  updatedBy String?
  user      User     @relation("UserKycLevelRelation", fields: [userId], references: [id], onDelete: Cascade)

  @@index([kycLevel])
}

model Integration {
  id          String    @id @default(cuid())
  service     String    @unique
  isEnabled   Boolean   @default(false)
  status      String    @default("inactive")
  apiKey      String?
  apiEndpoint String?
  lastTested  DateTime?
  config      Json?
  rates       Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([service])
  @@index([isEnabled])
  @@index([status])
}

model IPBlacklist {
  id              String    @id @default(cuid())
  ipAddress       String    @unique
  reason          String
  blockedBy       String
  isActive        Boolean   @default(true)
  expiresAt       DateTime?
  blockedAttempts Int       @default(0)
  lastAttemptAt   DateTime?
  metadata        Json?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  blockedByUser   User      @relation("BlockedBy", fields: [blockedBy], references: [id])

  @@index([ipAddress])
  @@index([isActive])
  @@index([expiresAt])
  @@index([blockedBy])
}

model SessionRevocation {
  id            String   @id @default(cuid())
  sessionKey    String   @unique
  userId        String
  ipAddress     String
  deviceType    String?
  browser       String?
  os            String?
  revokedBy     String
  reason        String?
  expiresAt     DateTime
  createdAt     DateTime @default(now())
  revokedByUser User     @relation("RevokedBy", fields: [revokedBy], references: [id])
  user          User     @relation("RevokedSessions", fields: [userId], references: [id], onDelete: Cascade)

  @@index([sessionKey])
  @@index([userId])
  @@index([ipAddress])
  @@index([expiresAt])
  @@index([createdAt])
}

model AdminSettings {
  id      String  @id @default(cuid())
  userId  String? @unique // Optional - for backward compatibility with User
  adminId String? @unique // New - for Admin model

  // Session Management
  idleTimeout        Int     @default(15)
  maxSessionDuration Int     @default(8)
  sessionTimeout     Int     @default(30) // Deprecated, use idleTimeout
  rememberDevice     Boolean @default(false)

  // MFA Settings
  twoFactorEnabled Boolean  @default(false)
  twoFactorMethod  String?
  requireMfaAlways Boolean  @default(false)
  requireStepUpFor String[] @default([])

  // Security
  loginNotifications  Boolean  @default(true)
  activityDigest      Boolean  @default(false)
  securityAlerts      Boolean  @default(true)
  allowedIPs          String[] @default([])
  blockUnknownDevices Boolean  @default(false)

  // Audit
  logAllActions Boolean @default(true)
  retainLogsFor Int     @default(90)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations (one will be null)
  user  User?  @relation("AdminSettings", fields: [userId], references: [id], onDelete: Cascade)
  admin Admin? @relation("AdminToSettings", fields: [adminId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([adminId])
}

// KycProvider model removed - we use Integration table instead for all providers (KYC, Blockchain, Payment, etc.)
// This follows our modular architecture where all integrations are managed through the Integration system

model KycProfile {
  id                     String     @id @default(cuid())
  kycSessionId           String     @unique
  firstName              String
  lastName               String
  dateOfBirth            DateTime
  placeOfBirth           String?
  nationality            String
  email                  String
  phone                  String
  phoneCountry           String?
  addressStreet          String?
  addressCity            String?
  addressRegion          String?
  addressCountry         String?
  addressPostal          String?
  idType                 String?
  idNumber               String?
  idIssuingCountry       String?
  idIssuingAuth          String?
  idIssueDate            DateTime?
  idExpiryDate           DateTime?
  idScanFront            String?
  idScanBack             String?
  livenessSelfie         String?
  pepStatus              Boolean    @default(false)
  pepCategory            String?
  sanctionsScreeningDone Boolean    @default(false)
  sanctionsProvider      String?
  sanctionsScreeningDate DateTime?
  sanctionsResult        String?
  sanctionsMatches       Json?
  employmentStatus       String?
  occupation             String?
  employerName           String?
  purposeOfAccount       String?
  intendedUse            String?
  expectedVolume         Float?
  expectedFrequency      String?
  expectedCountries      String[]
  sourceOfFunds          String?
  sourceOfWealth         String?
  riskScore              Int?
  riskFactors            Json?
  riskJustification      String?
  consentKyc             Boolean    @default(false)
  consentAml             Boolean    @default(false)
  consentTfr             Boolean    @default(false)
  consentPrivacy         Boolean    @default(false)
  termsVersion           String?
  privacyVersion         String?
  ipAddress              String?
  userAgent              String?
  completedAt            DateTime?
  verifiedBy             String?
  verifiedAt             DateTime?
  createdAt              DateTime   @default(now())
  updatedAt              DateTime   @updatedAt
  kycSession             KycSession @relation(fields: [kycSessionId], references: [id], onDelete: Cascade)

  @@index([kycSessionId])
  @@index([email])
  @@index([nationality])
  @@index([pepStatus])
}

model LegalDocument {
  id                String           @id @default(cuid())
  key               String           @unique
  title             String
  description       String?
  slug              String?          @unique
  category          DocumentCategory
  isRequired        Boolean          @default(false)
  content           Json
  htmlContent       String?
  plainText         String?
  status            DocumentStatus   @default(DRAFT)
  publishedAt       DateTime?
  publishedBy       String?
  version           Int              @default(1)
  previousVersionId String?
  isLatest          Boolean          @default(true)
  metaTitle         String?
  metaDescription   String?
  ogImage           String?
  isPublic          Boolean          @default(false)
  allowedRoles      String[]         @default(["ADMIN"])
  createdBy         String
  updatedBy         String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  changeLog         Json?

  @@index([key])
  @@index([slug])
  @@index([category])
  @@index([status])
  @@index([isPublic])
  @@index([publishedAt])
}

model DocumentTemplate {
  id          String           @id @default(cuid())
  name        String
  description String?
  category    DocumentCategory
  content     Json
  variables   Json?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([category])
}

enum Role {
  CLIENT
  ADMIN
}

enum KycStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

enum OrderStatus {
  PENDING
  PAYMENT_PENDING
  PAYMENT_RECEIVED
  PROCESSING
  COMPLETED
  CANCELLED
  EXPIRED
  REFUNDED
  FAILED
}

enum EmailStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  BOUNCED
}

enum SettingType {
  STRING
  NUMBER
  BOOLEAN
  JSON
}

enum PaymentAccountType {
  BANK_ACCOUNT
  CRYPTO_WALLET
}

enum PayInStatus {
  PENDING
  RECEIVED
  VERIFIED
  PARTIAL
  MISMATCH
  RECONCILED
  FAILED
  REFUNDED
  EXPIRED
}

enum PayOutStatus {
  PENDING
  QUEUED
  PROCESSING
  SENT
  CONFIRMING
  CONFIRMED
  FAILED
  CANCELLED
}

enum CurrencyType {
  FIAT
  CRYPTO
}

enum PaymentDirection {
  IN
  OUT
  BOTH
}

enum ProviderType {
  MANUAL
  BANK_ACCOUNT
  PSP
  CRYPTO_WALLET
}

enum AutomationLevel {
  MANUAL
  SEMI_AUTO
  FULLY_AUTO
}

enum DocumentCategory {
  PUBLIC
  INTERNAL
  LEGAL
}

enum DocumentStatus {
  DRAFT
  REVIEW
  PUBLISHED
  ARCHIVED
}

//  ==========================================
// IDENTITY & ACCESS MANAGEMENT - NEW MODELS
// ==========================================

// New Enums
enum AdminRole {
  SUPER_ADMIN
  ADMIN
  COMPLIANCE
  TREASURY_APPROVER
  FINANCE
  SUPPORT
  READ_ONLY
}

enum AdminStatus {
  INVITED // Приглашён, ожидает регистрации Passkey (15 минут)
  ACTIVE // Активный
  SUSPENDED // Приостановлен (временно)
  TERMINATED // Уволен (permanent)
}

enum AuthMethod {
  PASSWORD
  SSO
  PASSKEY
  HYBRID
}

enum MfaChallengeStatus {
  PENDING
  VERIFIED
  EXPIRED
  FAILED
}

// Admin Model (separate from User)
model Admin {
  id    String @id @default(cuid())
  orgId String @default("default") // Tenant/Organization ID

  // Basic Identity (Required)
  firstName String // Имя
  lastName  String // Фамилия
  workEmail String? @unique // Корпоративная почта (уникальный логин) - temporarily optional
  jobTitle  String? // Должность: Compliance Officer, Treasury Approver, etc. - temporarily optional

  // Optional Identity
  department String? // Отдел
  employeeId String? @unique @default(cuid()) // Уникальный табельный номер (автогенерация)
  managerId  String? // ID руководителя (для заявок/лимитов)

  // Localization
  locale   String @default("en") // en, ru, uk, etc.
  timezone String @default("UTC") // Europe/Kiev, UTC, etc.

  // Legacy field (for backward compatibility)
  email    String? // Deprecated: use workEmail instead
  password String? // Optional if using SSO/Passkey only

  // Role and Access (RBAC/SoD)
  role     AdminRole  @default(ADMIN) // Legacy enum (deprecated, use roleCode)
  roleCode String?    @default("ADMIN") // New: reference to RoleModel table
  roleModel RoleModel? @relation("AdminRole", fields: [roleCode], references: [code], onDelete: SetNull)

  // Separation of Duties (SoD) flags
  canInitiatePayout Boolean @default(false) // Может инициировать выплату
  canApprovePayout  Boolean @default(false) // Может утверждать выплату

  // Scope (JSON: какие подразделения/продукты админ видит)
  scope Json? // { departments: ["treasury", "compliance"], products: ["crypto", "fiat"] }

  // Status
  status AdminStatus @default(ACTIVE) // ACTIVE, SUSPENDED, TERMINATED

  // Legacy status fields (for backward compatibility)
  isActive       Boolean   @default(true)
  isSuspended    Boolean   @default(false)
  suspendedUntil DateTime?
  lastLogin      DateTime?

  // Auth methods
  authMethod  AuthMethod @default(PASSWORD)
  ssoProvider String? // google-workspace, microsoft, okta
  ssoSubject  String? // SSO subject ID

  // First-time setup (for Passkey registration via invite link)
  setupToken       String?   @unique // Hashed token for invite link
  setupTokenExpiry DateTime? // Token expiration
  invitedBy        String? // Admin ID who invited
  invitedAt        DateTime? // Invitation timestamp

  // Metadata
  createdAt DateTime @default(now())
  createdBy String? // Admin ID who created
  updatedAt DateTime @updatedAt

  // Relations
  twoFactorAuth       AdminTwoFactorAuth?
  sessions            AdminSession[]
  settings            AdminSettings?       @relation("AdminToSettings")
  webAuthnCreds       WebAuthnCredential[]
  mfaChallenges       MfaChallenge[]
  oneTimeTokens       OneTimeAuthToken[]   @relation("AdminOTAT")
  
  // Audit Logs
  auditLogs           AdminAuditLog[]      @relation("AdminAuditLogs") // NEW: отдельная таблица для админов
  auditLogsCreated    AuditLog[]           // LEGACY: старая таблица
  mfaEvents           MfaEvent[]           @relation("AdminMfaEvents")
  
  subordinates        Admin[]              @relation("ManagerSubordinates") // Подчинённые
  manager             Admin?               @relation("ManagerSubordinates", fields: [managerId], references: [id])
  payInsInitiated     PayIn[]              @relation("PayInInitiator")
  payInsApproved      PayIn[]              @relation("PayInApprover")
  payOutsInitiated    PayOut[]             @relation("PayOutInitiator")
  payOutsApproved     PayOut[]             @relation("PayOutApprover")
  invitedAdmins       Admin[]              @relation("AdminInviter") // Admins invited by this admin
  inviter             Admin?               @relation("AdminInviter", fields: [invitedBy], references: [id])

  @@unique([ssoProvider, ssoSubject])
  @@index([workEmail])
  @@index([orgId])
  @@index([role])
  @@index([status])
  @@index([managerId])
  @@index([invitedBy])
  @@index([setupToken])
}

// Roles and Permissions
model RoleModel {
  code        String   @id @unique
  name        String
  description String?
  isSystem    Boolean  @default(false)
  isActive    Boolean  @default(true)
  priority    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  permissions RolePermission[]
  admins      Admin[]          @relation("AdminRole")

  @@index([isActive])
  @@map("Role_")
}

model Permission {
  code        String   @id @unique
  name        String
  resource    String
  action      String
  description String?
  category    String
  isSystem    Boolean  @default(false)
  createdAt   DateTime @default(now())

  roles RolePermission[]

  @@unique([resource, action])
  @@index([resource])
  @@index([category])
}

model RolePermission {
  id             String   @id @default(cuid())
  roleCode       String
  permissionCode String
  createdAt      DateTime @default(now())

  role       RoleModel  @relation(fields: [roleCode], references: [code], onDelete: Cascade)
  permission Permission @relation(fields: [permissionCode], references: [code], onDelete: Cascade)

  @@unique([roleCode, permissionCode])
  @@index([roleCode])
  @@index([permissionCode])
}

// WebAuthn Credentials (Passkeys)
model WebAuthnCredential {
  id      String @id @default(cuid())
  adminId String

  // WebAuthn fields
  credentialId String @unique
  publicKey    String
  counter      Int    @default(0)

  // Device info
  deviceName String?
  deviceType String?
  transports String[]

  // Attestation
  aaguid      String?
  attestation String?

  // Status
  isActive Boolean   @default(true)
  lastUsed DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  admin Admin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([credentialId])
}

// Admin 2FA (TOTP + WebAuthn)
model AdminTwoFactorAuth {
  id      String @id @default(cuid())
  adminId String @unique

  // TOTP
  totpEnabled    Boolean   @default(false)
  totpSecret     String?
  totpVerifiedAt DateTime?

  // WebAuthn
  webAuthnEnabled  Boolean @default(false)
  webAuthnRequired Boolean @default(false)

  // Backup codes
  backupCodes Json?

  // Settings
  preferredMethod String @default("TOTP")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  admin Admin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
}

// MFA Challenges (Step-up MFA)
model MfaChallenge {
  id           String  @id @default(cuid())
  adminId      String
  action       String
  resourceType String?
  resourceId   String?

  // Challenge details
  challengeType String
  challenge     String

  // Status
  status      MfaChallengeStatus @default(PENDING)
  attempts    Int                @default(0)
  maxAttempts Int                @default(3)

  // Verification
  verifiedAt   DateTime?
  verifiedWith String?

  // Expiration
  expiresAt DateTime
  createdAt DateTime @default(now())

  admin Admin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId, status])
  @@index([expiresAt])
}

// Admin Sessions (Enhanced)
model AdminSession {
  id      String @id @default(cuid())
  adminId String

  // Session identification
  sessionId    String @unique
  sessionToken String @unique
  sessionKey   String

  // Device info
  ipAddress      String
  deviceType     String?
  browser        String?
  browserVersion String?
  os             String?
  osVersion      String?
  userAgent      String

  // Location
  country String?
  city    String?

  // MFA info
  mfaMethod     String?
  mfaVerifiedAt DateTime?

  // Status
  isActive Boolean @default(true)

  // Timeouts
  createdAt    DateTime @default(now())
  lastActivity DateTime @default(now())
  expiresAt    DateTime

  // Settings
  idleTimeout Int?
  maxDuration Int?

  // Termination
  terminatedAt      DateTime?
  terminatedBy      String?
  terminationReason String?

  updatedAt DateTime @updatedAt

  admin Admin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId, isActive])
  @@index([sessionId])
  @@index([sessionToken])
  @@index([sessionKey])
  @@index([lastActivity])
  @@index([expiresAt])
  @@index([ipAddress])
}

// Break-glass Emergency Access
model BreakGlassUser {
  id           String @id @default(cuid())
  username     String @unique
  passwordHash String
  totpSecret   String

  // Restrictions
  isActive   Boolean   @default(false)
  lastUsed   DateTime?
  usageCount Int       @default(0)

  // Access info
  accessInstructions String

  // Auto-disable
  autoDisableAfter Int @default(24)

  createdAt DateTime @default(now())
}

// Enhanced Audit Log
model AuditLogEnhanced {
  id String @id @default(cuid())

  // Who
  userId    String?
  userEmail String?
  userRole  String?

  // What
  action   String
  entity   String
  entityId String

  // Changes
  oldValue Json?
  newValue Json?
  changes  Json?

  // Context
  metadata Json?
  reason   String?

  // Where & When
  ipAddress String
  userAgent String
  country   String?
  city      String?

  // MFA verification
  mfaRequired   Boolean   @default(false)
  mfaMethod     String?
  mfaVerifiedAt DateTime?

  // Compliance
  severity     String    @default("INFO")
  isReviewable Boolean   @default(false)
  reviewedAt   DateTime?
  reviewedBy   String?

  // Immutability
  createdAt DateTime @default(now())
  hash      String?

  @@index([userId])
  @@index([entity, entityId])
  @@index([action])
  @@index([createdAt])
  @@index([severity])
  @@index([isReviewable])
  @@index([userRole])
  @@map("AuditLog_Enhanced")
}

// One-Time Authentication Token for secure Passkey session creation
model OneTimeAuthToken {
  id      String @id @default(cuid())
  token   String @unique
  adminId String
  admin   Admin  @relation("AdminOTAT", fields: [adminId], references: [id], onDelete: Cascade)

  createdAt DateTime  @default(now())
  expiresAt DateTime
  usedAt    DateTime?
  usedFrom  String? // IP address

  @@index([token, expiresAt])
  @@index([adminId])
  @@map("OneTimeAuthToken")
}

// ============================================================================
// NOTIFICATION SYSTEM
// ============================================================================

// Notification Events - система событий для уведомлений
model NotificationEvent {
  id          String   @id @default(cuid())
  eventKey    String   @unique // 'ORDER_CREATED', 'KYC_APPROVED', etc.
  name        String   // "Order Created"
  description String?
  category    EventCategory // ORDER, KYC, PAYMENT, SECURITY, SYSTEM
  
  // Channels - какие каналы поддерживает это событие
  channels    NotificationChannel[] // ['EMAIL', 'IN_APP', 'SMS']
  
  // Priority
  priority    EventPriority @default(NORMAL)
  
  // Status
  isActive    Boolean  @default(true)
  isSystem    Boolean  @default(false) // System events cannot be deleted
  
  // Template (optional - для будущей интеграции с шаблонами)
  templateKey String?
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  subscriptions NotificationSubscription[]
  queue         NotificationQueue[]
  
  @@index([eventKey])
  @@index([category])
  @@index([isActive])
}

// Notification Queue - очередь для асинхронной отправки
model NotificationQueue {
  id            String   @id @default(cuid())
  
  // Event
  eventKey      String
  event         NotificationEvent @relation(fields: [eventKey], references: [eventKey])
  
  // Recipient
  userId        String?
  user          User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipientEmail String? // For non-users or explicit email
  recipientPhone String? // For SMS
  
  // Channel
  channel       NotificationChannel
  
  // Content
  subject       String?  // For email
  message       String   @db.Text
  data          Json     // Event data for rendering
  
  // Template
  templateKey   String?
  
  // Status
  status        QueueStatus @default(PENDING)
  attempts      Int         @default(0)
  maxAttempts   Int         @default(3)
  
  // Scheduling
  scheduledFor  DateTime    @default(now())
  processedAt   DateTime?
  sentAt        DateTime?
  failedAt      DateTime?
  
  // Result
  messageId     String?     // Provider's message ID
  error         String?
  errorDetails  Json?
  
  // Provider
  providerId    String?     // Which provider was used (resend, twilio, etc.)
  
  // Metadata
  metadata      Json?
  
  // Timestamps
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@index([status, scheduledFor])
  @@index([userId])
  @@index([channel])
  @@index([eventKey])
  @@index([createdAt])
}

// Notification History - история уведомлений (для in-app)
model NotificationHistory {
  id          String   @id @default(cuid())
  
  // User
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Event
  eventKey    String
  
  // Channel
  channel     NotificationChannel
  
  // Content
  title       String
  message     String   @db.Text
  data        Json?
  
  // Status
  isRead      Boolean  @default(false)
  readAt      DateTime?
  
  // Actions
  isClicked   Boolean  @default(false)
  clickedAt   DateTime?
  
  // Link
  actionUrl   String?
  
  // Timestamps
  createdAt   DateTime @default(now())
  
  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@index([eventKey])
}

// Notification Subscription - настройки пользователя
model NotificationSubscription {
  id          String   @id @default(cuid())
  
  // User
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Event
  eventKey    String
  event       NotificationEvent @relation(fields: [eventKey], references: [eventKey])
  
  // Channels (какие каналы включены для этого события)
  emailEnabled   Boolean @default(true)
  inAppEnabled   Boolean @default(true)
  smsEnabled     Boolean @default(false)
  pushEnabled    Boolean @default(false)
  
  // Preferences
  frequency   NotificationFrequency @default(INSTANT)
  quietHours  Json? // { start: "22:00", end: "08:00", timezone: "Europe/Warsaw" }
  
  // Status
  isActive    Boolean  @default(true)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([userId, eventKey])
  @@index([userId])
  @@index([eventKey])
}

// ============================================================================
// ENUMS FOR NOTIFICATION SYSTEM
// ============================================================================

enum EventCategory {
  ORDER
  KYC
  PAYMENT
  SECURITY
  SYSTEM
  ADMIN
  MARKETING
}

enum EventPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum NotificationChannel {
  EMAIL
  IN_APP
  SMS
  PUSH
}

enum QueueStatus {
  PENDING
  PROCESSING
  SENT
  FAILED
  CANCELLED
  SKIPPED  // User unsubscribed or quiet hours
}

enum NotificationFrequency {
  INSTANT     // Сразу
  HOURLY      // Раз в час (digest)
  DAILY       // Раз в день (digest)
  WEEKLY      // Раз в неделю (digest)
}

// ============================================================================
// EMAIL TEMPLATES (White-Label Support)
// ============================================================================

// Email Template - шаблоны писем с white-label поддержкой
model EmailTemplate {
  id          String   @id @default(cuid())
  
  // Organization (white-label) - null = global template
  orgId       String?
  
  // Template identification
  key         String   // 'ORDER_CREATED', 'KYC_APPROVED', etc.
  name        String   // "Order Created Email"
  description String?
  category    EmailCategory
  
  // Content
  subject     String   // "Your order #{{orderId}} has been created"
  htmlContent String   @db.Text // HTML template with {{variables}}
  textContent String?  @db.Text // Plain text fallback
  
  // Design
  preheader   String?  // Email preview text
  layout      String   @default("default") // 'default', 'minimal', 'marketing'
  
  // Variables & Metadata
  variables   Json     // Required variables: ['orderId', 'amount', etc.]
  metadata    Json?    // Custom metadata
  
  // Versioning
  version     Int      @default(1)
  isActive    Boolean  @default(true)
  isDefault   Boolean  @default(false) // System default template
  
  // Status
  status      TemplateStatus @default(DRAFT)
  publishedAt DateTime?
  publishedBy String?
  
  // Audit
  createdBy   String?
  updatedBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  emailLogs   EmailLog[] @relation("TemplateUsed")
  
  @@unique([orgId, key, version])
  @@index([orgId, key])
  @@index([category])
  @@index([status])
  @@index([isActive])
}

enum EmailCategory {
  TRANSACTIONAL  // Order confirmations, receipts
  NOTIFICATION   // Status updates, alerts
  MARKETING      // Newsletters, promotions
  SYSTEM         // Password reset, email verification
  COMPLIANCE     // KYC updates, AML alerts
}

enum TemplateStatus {
  DRAFT
  REVIEW
  PUBLISHED
  ARCHIVED
}

