# üîê MFA –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ - –ê–Ω–∞–ª–∏–∑ –∏ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

## ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê

### –¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è:

**–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –ù–ï –ú–û–ì–£–¢ –≤–æ–π—Ç–∏ –∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –±–µ–∑ WebAuthn (Passkey)!**

```typescript
// src/app/(admin)/admin/auth/login/page.tsx
// ‚ùå –¢–û–õ–¨–ö–û Passkey –¥–ª—è –≤—Ö–æ–¥–∞!
<PasskeyLoginButton
  email={adminEmail}
  onSuccess={() => window.location.href = '/admin'}
/>

// src/lib/services/passkey.service.ts
// ‚ùå –ü—Ä–∏ –ø–µ—Ä–≤–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Passkey!
await PasskeyService.verifyPasskeyRegistration(adminId, response, deviceName);
```

**–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç:**
1. ‚ùå **–í—Ö–æ–¥**: –ê–¥–º–∏–Ω –ù–ï –ú–û–ñ–ï–¢ –≤–æ–π—Ç–∏ –±–µ–∑ Passkey (–Ω–µ—Ç –ø–∞—Ä–æ–ª—è + TOTP)
2. ‚ùå **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è**: –ü—Ä–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–∏ –∞–¥–º–∏–Ω –û–ë–Ø–ó–ê–ù –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Passkey
3. ‚ùå **Step-up MFA**: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –¢–û–õ–¨–ö–û —á–µ—Ä–µ–∑ WebAuthn

---

## üìä –ß—Ç–æ –¥–æ—Å—Ç—É–ø–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –°–ï–ô–ß–ê–°:

### 1. **Passkey (WebAuthn) - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û** ‚úÖ

**–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:**
- YubiKey ($50-70) - USB-–∫–ª—é—á
- Windows Hello - PIN, –æ—Ç–ø–µ—á–∞—Ç–æ–∫, Face ID (–≤—Å—Ç—Ä–æ–µ–Ω–æ –≤ Windows 10/11)
- Touch ID / Face ID (Mac)
- Android –±–∏–æ–º–µ—Ç—Ä–∏—è

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è **–ü—Ä–∏–≤—è–∑–∫–∞ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É**: Passkey —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ, –≥–¥–µ –±—ã–ª –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
- ‚ö†Ô∏è **–°–º–µ–Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞**: –ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –¥—Ä—É–≥–æ–≥–æ –ü–ö - –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚ö†Ô∏è **YubiKey**: –î–æ—Ä–æ–≥–æ ($50), –Ω—É–∂–Ω–æ –Ω–æ—Å–∏—Ç—å —Å —Å–æ–±–æ–π, –º–æ–∂–Ω–æ –ø–æ—Ç–µ—Ä—è—Ç—å
- ‚ö†Ô∏è **Windows Hello**: –ù—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –Ω–∞ –∫–∞–∂–¥–æ–º –ü–ö –æ—Ç–¥–µ–ª—å–Ω–æ

---

### 2. **Emergency Access (—Ç–æ–ª—å–∫–æ –¥–ª—è —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤)** ‚úÖ

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
```
URL: /admin/auth/emergency
–¢—Ä–µ–±—É–µ—Ç:
  - Email
  - Password (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞—Ä–∞–Ω–µ–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
  - TOTP –∫–æ–¥ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞—Ä–∞–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è –ü—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¢–û–õ–¨–ö–û –¥–ª—è —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ (–µ—Å–ª–∏ –ø–æ—Ç–µ—Ä—è–Ω Passkey)
- ‚ö†Ô∏è –ù–ï –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- ‚ö†Ô∏è –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ audit log –∫–∞–∫ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–±—ã—Ç–∏–µ

---

### 3. **TOTP –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ (–ù–ï –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)** ‚úÖ

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```typescript
// src/app/api/2fa/setup/route.ts
// ‚ö†Ô∏è –†–∞–±–æ—Ç–∞–µ—Ç –¢–û–õ–¨–ö–û –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ (User), –ù–ï –¥–ª—è Admin!
export async function POST(request: NextRequest) {
  const session = await getClientSession(); // ‚Üê CLIENT session
  // ...
}
```

---

## üéØ –ü–†–û–ë–õ–ï–ú–ê: –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –Ω–µ—É–¥–æ–±–Ω–æ

### –†–µ–∞–ª—å–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:

#### –°—Ü–µ–Ω–∞—Ä–∏–π 1: **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ä–∞–∑–Ω—ã—Ö –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–≤**
```
–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫: –û—Ñ–∏—Å –ü–ö (Windows Hello –Ω–∞—Å—Ç—Ä–æ–µ–Ω) ‚úÖ
–í—Ç–æ—Ä–Ω–∏–∫: –î–æ–º–∞—à–Ω–∏–π –ü–ö (Windows Hello –ù–ï –Ω–∞—Å—Ç—Ä–æ–µ–Ω) ‚ùå
–°—Ä–µ–¥–∞: –ù–æ—É—Ç–±—É–∫ –≤ –∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–∫–µ (Windows Hello –ù–ï –Ω–∞—Å—Ç—Ä–æ–µ–Ω) ‚ùå
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ê–¥–º–∏–Ω –ù–ï –ú–û–ñ–ï–¢ –≤–æ–π—Ç–∏!

#### –°—Ü–µ–Ω–∞—Ä–∏–π 2: **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø–æ—Ç–µ—Ä—è–ª YubiKey**
```
1. YubiKey –ø–æ—Ç–µ—Ä—è–Ω –∏–ª–∏ —É–∫—Ä–∞–¥–µ–Ω
2. Emergency access —Ä–∞–±–æ—Ç–∞–µ—Ç, –ù–û...
3. –ù—É–∂–Ω–æ –∫–∞–∂–¥—ã–π —Ä–∞–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å emergency (–Ω–µ—É–¥–æ–±–Ω–æ)
4. –ù—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –Ω–æ–≤—ã–π Passkey
```

#### –°—Ü–µ–Ω–∞—Ä–∏–π 3: **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è (Step-up MFA)**
```typescript
// –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∞–¥–º–∏–Ω–∞, –æ–¥–æ–±—Ä–µ–Ω–∏–µ –≤—ã–ø–ª–∞—Ç—ã, –∏–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫...
// ‚ùå –¢–†–ï–ë–£–ï–¢–°–Ø WebAuthn (YubiKey –∏–ª–∏ Windows Hello)

if (!validatedData.mfaChallengeId) {
  const challenge = await stepUpMfaService.requestChallenge(
    session.user.id,
    'CREATE_ADMIN' // ‚Üê –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ
  );
  // ‚ö†Ô∏è –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¢–û–õ–¨–ö–û WebAuthn options
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ï—Å–ª–∏ –∞–¥–º–∏–Ω –±–µ–∑ YubiKey –∏–ª–∏ –Ω–∞ —á—É–∂–æ–º –ü–ö - –ù–ï –ú–û–ñ–ï–¢ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è!

---

## üí° –†–ï–®–ï–ù–ò–ï: 3 —É—Ä–æ–≤–Ω—è –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

### –£—Ä–æ–≤–µ–Ω—å 1: **–ú–ò–ù–ò–ú–ê–õ–¨–ù–´–ô (1-2 –¥–Ω—è)** - –î–æ–±–∞–≤–∏—Ç—å TOTP –¥–ª—è Step-up MFA

**–¶–µ–ª—å:** –ü–æ–∑–≤–æ–ª–∏—Ç—å –∞–¥–º–∏–Ω–∞–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å authenticator app –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π

**–ß—Ç–æ –º–µ–Ω—è–µ–º:**
- ‚úÖ Step-up MFA (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è) - –≤—ã–±–æ—Ä –º–µ–∂–¥—É Passkey –∏ TOTP
- ‚ùå –í—Ö–æ–¥ - –æ—Å—Ç–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û —á–µ—Ä–µ–∑ Passkey

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ê–¥–º–∏–Ω –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ä–∞–∑–Ω—ã—Ö –ü–ö (–¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π)
- –ù–æ –≤—Å–µ —Ä–∞–≤–Ω–æ –Ω—É–∂–µ–Ω Passkey –¥–ª—è –≤—Ö–æ–¥–∞

---

### –£—Ä–æ–≤–µ–Ω—å 2: **–°–†–ï–î–ù–ò–ô (3-5 –¥–Ω–µ–π)** - –†–∞–∑—Ä–µ—à–∏—Ç—å Password + TOTP –¥–ª—è –≤—Ö–æ–¥–∞

**–¶–µ–ª—å:** –ü–æ–ª–Ω–∞—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ Passkey –¥–ª—è –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –≤—Ö–æ–¥–∞

**–ß—Ç–æ –º–µ–Ω—è–µ–º:**
- ‚úÖ –í—Ö–æ–¥ - –≤—ã–±–æ—Ä –º–µ–∂–¥—É Passkey –∏ Password + TOTP
- ‚úÖ Step-up MFA - –≤—ã–±–æ—Ä –º–µ–∂–¥—É Passkey –∏ TOTP
- ‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è - –≤—ã–±–æ—Ä –º–µ—Ç–æ–¥–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ê–¥–º–∏–Ω –º–æ–∂–µ—Ç –≤–æ–π—Ç–∏ —Å –õ–Æ–ë–û–ì–û –∫–æ–º–ø—å—é—Ç–µ—Ä–∞ –±–µ–∑ Passkey
- –ê–¥–º–∏–Ω —Å–∞–º –≤—ã–±–∏—Ä–∞–µ—Ç: —É–¥–æ–±—Å—Ç–≤–æ (TOTP) –∏–ª–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (Passkey)

---

### –£—Ä–æ–≤–µ–Ω—å 3: **–ü–û–õ–ù–´–ô (5-7 –¥–Ω–µ–π)** - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º—ã–µ Passkeys

**–¶–µ–ª—å:** Passkey —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –∞–¥–º–∏–Ω–∞

**–ß—Ç–æ –º–µ–Ω—è–µ–º:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º synced passkeys (iCloud Keychain, Google Password Manager)
- ‚úÖ –û–¥–∏–Ω Passkey - —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –∞–¥–º–∏–Ω–∞
- ‚úÖ –ù–µ –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –Ω–∞ –∫–∞–∂–¥–æ–º –ü–ö

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ê–¥–º–∏–Ω –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç Passkey –æ–¥–∏–Ω —Ä–∞–∑
- –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –≤—Å–µ—Ö –µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö (iPhone, Mac, iPad, Windows)
- –°–∞–º—ã–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ò —É–¥–æ–±–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç

---

## üõ†Ô∏è –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø: –£—Ä–æ–≤–µ–Ω—å 2 (Password + TOTP)

### –ü–æ—á–µ–º—É –£—Ä–æ–≤–µ–Ω—å 2 - –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π:

1. **–ë–∞–ª–∞–Ω—Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ —É–¥–æ–±—Å—Ç–≤–∞**
   - Password + TOTP - –æ—á–µ–Ω—å –Ω–∞–¥–µ–∂–Ω–æ (2FA)
   - –†–∞–±–æ—Ç–∞–µ—Ç —Å –ª—é–±–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
   - –ù–µ –Ω—É–∂–Ω—ã YubiKey –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Windows Hello –Ω–∞ –∫–∞–∂–¥–æ–º –ü–ö

2. **–ì–∏–±–∫–æ—Å—Ç—å –¥–ª—è –∞–¥–º–∏–Ω–æ–≤**
   - SUPER_ADMIN –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Passkey (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
   - –û–±—ã—á–Ω—ã–µ –∞–¥–º–∏–Ω—ã –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Password + TOTP (—É–¥–æ–±–Ω–æ)
   - –ö–∞–∂–¥—ã–π –≤—ã–±–∏—Ä–∞–µ—Ç —Å–∞–º

3. **–ë—ã—Å—Ç—Ä–æ–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ**
   - 3-5 –¥–Ω–µ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
   - –ù–µ –Ω—É–∂–Ω–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è synced passkeys
   - –í—Å–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ —É–∂–µ –µ—Å—Ç—å –≤ –ø—Ä–æ–µ–∫—Ç–µ

---

## üìã –ü–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è (–£—Ä–æ–≤–µ–Ω—å 2)

### –≠—Ç–∞–ø 1: –°–æ–∑–¥–∞—Ç—å API –¥–ª—è TOTP setup (–∞–¥–º–∏–Ω—ã) - 1 –¥–µ–Ω—å

**–§–∞–π–ª—ã:**
- `src/app/api/admin/2fa/setup/route.ts` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–∞ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
- `src/app/api/admin/2fa/verify/route.ts` - –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –≤–∫–ª—é—á–µ–Ω–∏–µ TOTP
- `src/app/api/admin/2fa/status/route.ts` - —Å—Ç–∞—Ç—É—Å 2FA –∞–¥–º–∏–Ω–∞

**–õ–æ–≥–∏–∫–∞:**
```typescript
// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç AdminTwoFactorAuth (–Ω–µ User TwoFactorAuth)
const admin2fa = await prisma.adminTwoFactorAuth.upsert({
  where: { adminId: session.user.id },
  create: {
    adminId: session.user.id,
    totpEnabled: true,
    totpSecret: encryptedSecret,
    totpVerifiedAt: new Date(),
    preferredMethod: 'TOTP', // –∏–ª–∏ 'WEBAUTHN'
  },
  // ...
});
```

---

### –≠—Ç–∞–ø 2: –î–æ–±–∞–≤–∏—Ç—å Password + TOTP –ª–æ–≥–∏–Ω - 2 –¥–Ω—è

**–§–∞–π–ª—ã:**
- `src/app/(admin)/admin/auth/login/page.tsx` - UI —Å –≤—ã–±–æ—Ä–æ–º –º–µ—Ç–æ–¥–∞
- `src/auth-admin.ts` - –¥–æ–±–∞–≤–∏—Ç—å Credentials provider
- `src/app/api/admin/auth/credentials/route.ts` - –Ω–æ–≤—ã–π endpoint

**UI –∏–∑–º–µ–Ω–µ–Ω–∏—è:**

```tsx
// Login page - –≤—ã–±–æ—Ä –º–µ—Ç–æ–¥–∞
<Tabs defaultValue="passkey">
  <TabsList>
    <TabsTrigger value="passkey">
      <Shield className="w-4 h-4 mr-2" />
      Passkey (Recommended)
    </TabsTrigger>
    <TabsTrigger value="password">
      <Key className="w-4 h-4 mr-2" />
      Password + 2FA
    </TabsTrigger>
  </TabsList>

  <TabsContent value="passkey">
    {/* –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π Passkey flow */}
  </TabsContent>

  <TabsContent value="password">
    <form onSubmit={handlePasswordLogin}>
      <Input type="email" name="email" />
      <Input type="password" name="password" />
      <Input type="text" name="totpCode" placeholder="6-digit code" />
      <Button type="submit">Sign In</Button>
    </form>
  </TabsContent>
</Tabs>
```

**Backend –ª–æ–≥–∏–∫–∞:**

```typescript
// src/auth-admin.ts - –¥–æ–±–∞–≤–∏—Ç—å Credentials provider
Credentials({
  id: 'password-totp',
  name: 'Password + TOTP',
  credentials: {
    email: { type: 'email' },
    password: { type: 'password' },
    totpCode: { type: 'text' }
  },
  async authorize(credentials) {
    // 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å email + password
    const admin = await prisma.admin.findUnique({
      where: { email: credentials.email },
      include: { twoFactorAuth: true }
    });

    if (!admin?.password) return null;

    const passwordValid = await verifyPassword(
      credentials.password,
      admin.password
    );

    if (!passwordValid) return null;

    // 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å TOTP –∫–æ–¥
    if (!admin.twoFactorAuth?.totpEnabled || !admin.twoFactorAuth?.totpSecret) {
      return null; // TOTP –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω
    }

    const totpValid = await verifyTotpCode(
      admin.twoFactorAuth.totpSecret,
      admin.email,
      credentials.totpCode
    );

    if (!totpValid) return null;

    // 3. –£—Å–ø–µ—à–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
    return {
      id: admin.id,
      email: admin.email,
      role: admin.role,
      authMethod: 'PASSWORD_TOTP'
    };
  }
});
```

---

### –≠—Ç–∞–ø 3: –î–æ–±–∞–≤–∏—Ç—å TOTP –¥–ª—è Step-up MFA - 1 –¥–µ–Ω—å

**–§–∞–π–ª—ã:**
- `src/lib/services/step-up-mfa.service.ts` - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ TOTP
- `src/components/admin/StepUpMfaDialog.tsx` - UI –≤—ã–±–æ—Ä–∞ –º–µ—Ç–æ–¥–∞

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

```typescript
// Step-up MFA —Å –≤—ã–±–æ—Ä–æ–º –º–µ—Ç–æ–¥–∞
async requestChallenge(adminId: string, action: string) {
  const admin2fa = await prisma.adminTwoFactorAuth.findUnique({
    where: { adminId }
  });

  const availableMethods = [];
  
  if (admin2fa?.totpEnabled) availableMethods.push('TOTP');
  if (admin2fa?.webAuthnEnabled) availableMethods.push('WEBAUTHN');

  return {
    challengeId: challenge.id,
    methods: availableMethods,
    options: admin2fa?.webAuthnEnabled ? webAuthnOptions : null
  };
}

async verifyChallenge(challengeId: string, method: string, response: any) {
  if (method === 'TOTP') {
    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥
    const isValid = await verifyTotpCode(/*...*/);
    // ...
  } else if (method === 'WEBAUTHN') {
    // –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ WebAuthn
    // ...
  }
}
```

---

### –≠—Ç–∞–ø 4: –ü–µ—Ä–≤–∏—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–∏ - 1 –¥–µ–Ω—å

**–§–∞–π–ª—ã:**
- `src/app/(admin)/admin/auth/setup-passkey/page.tsx` - –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –≤ `setup-auth`
- –î–æ–±–∞–≤–∏—Ç—å –≤—ã–±–æ—Ä –º–µ—Ç–æ–¥–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–µ

**UI:**

```tsx
// Setup page - –≤—ã–±–æ—Ä –º–µ—Ç–æ–¥–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ –∞–¥–º–∏–Ω–∞
<Card>
  <CardHeader>
    <CardTitle>Choose Your Authentication Method</CardTitle>
  </CardHeader>
  <CardContent>
    <RadioGroup defaultValue="totp">
      <div className="border rounded-lg p-4">
        <RadioGroupItem value="totp" id="totp" />
        <Label htmlFor="totp">
          <Smartphone className="inline w-5 h-5 mr-2" />
          <strong>Password + Authenticator App</strong>
          <p className="text-sm text-muted-foreground">
            Works on any device. Recommended for most admins.
          </p>
        </Label>
      </div>

      <div className="border rounded-lg p-4">
        <RadioGroupItem value="passkey" id="passkey" />
        <Label htmlFor="passkey">
          <Shield className="inline w-5 h-5 mr-2" />
          <strong>Passkey (Biometric / Security Key)</strong>
          <p className="text-sm text-muted-foreground">
            Fastest and most secure. Recommended for SUPER_ADMIN.
          </p>
        </Label>
      </div>
    </RadioGroup>

    <Button onClick={handleSetup}>Continue</Button>
  </CardContent>
</Card>
```

**–õ–æ–≥–∏–∫–∞:**

```typescript
// –ü—Ä–∏ –≤—ã–±–æ—Ä–µ TOTP:
// 1. –°–æ–∑–¥–∞—Ç—å password –¥–ª—è –∞–¥–º–∏–Ω–∞
// 2. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å TOTP secret
// 3. –ü–æ–∫–∞–∑–∞—Ç—å QR-–∫–æ–¥
// 4. –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–≤—ã–π –∫–æ–¥
// 5. –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∞–¥–º–∏–Ω–∞

// –ü—Ä–∏ –≤—ã–±–æ—Ä–µ Passkey:
// –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π flow (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
```

---

## üéØ –ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

### –ß—Ç–æ –ø–æ–ª—É—á–∏—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:

#### –ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (setup):
```
1. –ü–æ–ª—É—á–∞–µ—Ç invite link
2. –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ
3. –í—ã–±–∏—Ä–∞–µ—Ç –º–µ—Ç–æ–¥:
   - Password + TOTP (–¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞)
   - Passkey (–¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
4. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Ç–æ–¥
5. –ü–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø
```

#### –ü—Ä–∏ –≤—Ö–æ–¥–µ:
```
–í–∞—Ä–∏–∞–Ω—Ç –ê (Password + TOTP):
  1. Email
  2. Password
  3. 6-digit code from app
  ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å –õ–Æ–ë–û–ì–û —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

–í–∞—Ä–∏–∞–Ω—Ç –ë (Passkey):
  1. Email
  2. Touch ID / Face ID / Windows Hello
  ‚úÖ –°–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π
```

#### –ü—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏—è—Ö:
```
–°–∏—Å—Ç–µ–º–∞ –∑–∞–ø—Ä–æ—Å–∏—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ:
  - –í—ã–±—Ä–∞—Ç—å –º–µ—Ç–æ–¥ (–µ—Å–ª–∏ –æ–±–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã)
  - –í–≤–µ—Å—Ç–∏ TOTP –∫–æ–¥ –ò–õ–ò –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Passkey
  ‚úÖ –ì–∏–±–∫–æ—Å—Ç—å
```

---

## üèÜ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ—à–µ–Ω–∏—è

### –î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤:

1. **–ì–∏–±–∫–æ—Å—Ç—å**
   - –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å TOTP —Å –ª—é–±–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
   - –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å Passkey –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ —Ä–∞–±–æ—á–µ–º –ü–ö
   - –ú–æ–∂–Ω–æ –∏–º–µ—Ç—å –æ–±–∞ –º–µ—Ç–æ–¥–∞ –∏ –≤—ã–±–∏—Ä–∞—Ç—å –ø–æ —Å–∏—Ç—É–∞—Ü–∏–∏

2. **–£–¥–æ–±—Å—Ç–≤–æ**
   - –ù–µ –Ω—É–∂–Ω–æ –ø–æ–∫—É–ø–∞—Ç—å YubiKey ($50-70)
   - –ù–µ –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å Windows Hello –Ω–∞ –∫–∞–∂–¥–æ–º –ü–ö
   - Authenticator app –µ—Å—Ç—å —É –≤—Å–µ—Ö

3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**
   - Password + TOTP = 2FA (–æ—á–µ–Ω—å –Ω–∞–¥–µ–∂–Ω–æ)
   - Passkey = phishing-resistant (–µ—â–µ –Ω–∞–¥–µ–∂–Ω–µ–µ)
   - Backup codes –Ω–∞ —Å–ª—É—á–∞–π –ø–æ—Ç–µ—Ä–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞

### –î–ª—è –∫–æ–º–ø–∞–Ω–∏–∏:

1. **–ù—É–ª–µ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å**
   - –ù–µ –Ω—É–∂–Ω–æ –ø–æ–∫—É–ø–∞—Ç—å YubiKey –¥–ª—è –≤—Å–µ—Ö –∞–¥–º–∏–Ω–æ–≤
   - –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ authenticator apps

2. **–°–Ω–∏–∂–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏**
   - –ú–µ–Ω—å—à–µ —Å–ª—É—á–∞–µ–≤ "–ø–æ—Ç–µ—Ä—è–ª –¥–æ—Å—Ç—É–ø"
   - –ê–¥–º–∏–Ω—ã –º–æ–≥—É—Ç –≤–æ–π—Ç–∏ —Å –ª—é–±–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

3. **Compliance**
   - –í—Å–µ —Ä–∞–≤–Ω–æ 2FA (PSD2/SCA compliant)
   - Audit log –≤—Å–µ—Ö –≤—Ö–æ–¥–æ–≤
   - Step-up MFA –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π

---

## üöÄ –ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ?

### –Ø –º–æ–≥—É –Ω–∞—á–∞—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å:

**–í–∞—Ä–∏–∞–Ω—Ç 1: –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (–£—Ä–æ–≤–µ–Ω—å 2) - 5 –¥–Ω–µ–π**
- –í—Å–µ 4 —ç—Ç–∞–ø–∞
- –ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –∞–¥–º–∏–Ω–æ–≤

**–í–∞—Ä–∏–∞–Ω—Ç 2: –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (–£—Ä–æ–≤–µ–Ω—å 1) - 2 –¥–Ω—è**
- –¢–æ–ª—å–∫–æ Step-up MFA (–≠—Ç–∞–ø 3)
- –í—Ö–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ Passkey

**–í–∞—Ä–∏–∞–Ω—Ç 3: –¢–æ–ª—å–∫–æ Windows Hello –≥–∞–π–¥ - 1 —á–∞—Å**
- –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –∫–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Windows Hello
- –î–ª—è —Ç–µ–∫—É—â–µ–π —Å–∏—Å—Ç–µ–º—ã (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∫–æ–¥–∞)

---

**–†–µ–∫–æ–º–µ–Ω–¥—É—é: –í–∞—Ä–∏–∞–Ω—Ç 1 (–ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)**

–≠—Ç–æ –¥–∞—Å—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –≥–∏–±–∫–æ—Å—Ç—å –¥–ª—è –≤–∞—à–µ–π –∫–æ–º–∞–Ω–¥—ã. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã —Å–º–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —É–¥–æ–±–Ω–æ, –∞ —Å–∏—Å—Ç–µ–º–∞ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π. 

**–ù–∞—á–∏–Ω–∞–µ–º?** üöÄ

