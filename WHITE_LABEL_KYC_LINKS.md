# White Label KYC Links - ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ğ¸ Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ

## ğŸ“‹ ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹

### Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ğ¡Ğ¸Ñ‚ÑƒĞ°Ñ†Ğ¸Ñ
**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:** ĞšĞ»Ğ¸ĞµĞ½Ñ‚ Ğ²Ğ¸Ğ´Ğ¸Ñ‚ Ğ¿Ñ€ÑĞ¼Ñ‹Ğµ ÑÑÑ‹Ğ»ĞºĞ¸ Ğ½Ğ° Sumsub:
```
https://api.sumsub.com/idensic/websdk/...
```

**Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:** Ğ¡ÑÑ‹Ğ»ĞºĞ¸ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ñ‹ Ğ±Ñ‹Ñ‚ÑŒ Ğ½Ğ° Ğ´Ğ¾Ğ¼ĞµĞ½Ğµ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°:
```
https://app.bitflow.biz/kyc/verify/...
```

### ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ¾Ñ‚ Unibit.cz
```
https://liveness.unibit.cz/_act-jwt-{TOKEN}?redirectLink=...&email=...&phone=...
```

**Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°:**
- `liveness.unibit.cz` - Ğ¿Ğ¾Ğ´Ğ´Ğ¾Ğ¼ĞµĞ½ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°
- `_act-jwt-{TOKEN}` - JWT Ñ‚Ğ¾ĞºĞµĞ½ Ñ Ğ·Ğ°ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸
- Query Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹: `redirectLink`, `email`, `phone`

---

## ğŸ—ï¸ ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ğ ĞµÑˆĞµĞ½Ğ¸Ñ

### Ğ’Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ 1: Proxy Redirect (Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµĞ¼Ñ‹Ğ¹)

**ĞŸÑ€ĞµĞ¸Ğ¼ÑƒÑ‰ĞµÑÑ‚Ğ²Ğ°:**
- âœ… ĞŸÑ€Ğ¾ÑÑ‚Ğ°Ñ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
- âœ… ĞĞµ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ² Sumsub
- âœ… ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»ÑŒ Ğ½Ğ°Ğ´ URL
- âœ… Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ Ğ°Ğ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ¸ (tracking)
- âœ… Ğ“Ğ¸Ğ±ĞºĞ¾ÑÑ‚ÑŒ Ğ´Ğ»Ñ Ğ±ÑƒĞ´ÑƒÑ‰Ğ¸Ñ… Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹

**ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚ĞºĞ¸:**
- âš ï¸ Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ñ€ĞµĞ´Ğ¸Ñ€ĞµĞºÑ‚ (Ğ½ĞµĞ·Ğ°Ğ¼ĞµÑ‚ĞµĞ½ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ)

**Ğ¡Ñ…ĞµĞ¼Ğ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹:**
```
1. ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ QR/ÑÑÑ‹Ğ»ĞºÑƒ: 
   https://app.bitflow.biz/api/kyc/verify/{TOKEN}

2. ĞĞ°Ñˆ ÑĞµÑ€Ğ²ĞµÑ€:
   - Ğ”ĞµĞºĞ¾Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ JWT Ñ‚Ğ¾ĞºĞµĞ½
   - Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ (Ğ°Ğ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ°)
   - Ğ ĞµĞ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¸Ñ‚ Ğ½Ğ° Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Sumsub URL

3. ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¿Ğ¾Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚ Ğ½Ğ° Sumsub Ğ²ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ
```

### Ğ’Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ 2: Sumsub External Link API

**Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ Sumsub:**
```
POST /resources/generate-websdk-external-link/
{
  "levelName": "basic-kyc",
  "userId": "user123",
  "applicantIdentifiers": {
    "email": "user@example.com",
    "phone": "+1234567890"
  },
  "redirect": {
    "successUrl": "https://app.bitflow.biz/kyc/success",
    "failureUrl": "https://app.bitflow.biz/kyc/failure"
  },
  "ttlInSecs": 3600
}
```

**ĞÑ‚Ğ²ĞµÑ‚:**
```json
{
  "link": "https://websdk.sumsub.com/verification/External/AbCdEfGhIjKlMnOpQrStUvWxYz"
}
```

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:** Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ²ÑĞµ Ñ€Ğ°Ğ²Ğ½Ğ¾ Ğ½Ğ° `websdk.sumsub.com` âŒ

### Ğ’Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ 3: WebSDK Settings + Custom Domain (Enterprise)

**Ğ˜Ğ· Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ğ¸ Sumsub:**
```json
{
  "domainsToHostWebSDK": [
    "https://app.bitflow.biz"
  ],
  "postVerificationRedirectUrl": "https://app.bitflow.biz/kyc/success"
}
```

**Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚:**
- ğŸ”’ Enterprise Ğ¿Ğ»Ğ°Ğ½ Sumsub
- ğŸŒ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° DNS (CNAME)
- âš™ï¸ ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ½Ğ° ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ğµ Sumsub

---

## âœ… Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµĞ¼Ğ¾Ğµ Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ: Proxy Redirect

### ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ White Label Ğ¡ÑÑ‹Ğ»ĞºĞ¸                            â”‚
â”‚                                                              â”‚
â”‚  /api/kyc/mobile-link (Ğ½Ğ°Ñˆ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ endpoint)           â”‚
â”‚  â†“                                                           â”‚
â”‚  ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Sumsub URL: https://api.sumsub.com/...            â”‚
â”‚  â†“                                                           â”‚
â”‚  Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ JWT Ñ‚Ğ¾ĞºĞµĞ½:                                         â”‚
â”‚  {                                                           â”‚
â”‚    userId: "user123",                                        â”‚
â”‚    sessionId: "kyc-session-id",                             â”‚
â”‚    provider: "sumsub",                                       â”‚
â”‚    targetUrl: "https://api.sumsub.com/...",                 â”‚
â”‚    exp: timestamp + 3600                                     â”‚
â”‚  }                                                           â”‚
â”‚  â†“                                                           â”‚
â”‚  Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ White Label URL:                                â”‚
â”‚  https://app.bitflow.biz/api/kyc/verify/{JWT_TOKEN}         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¡ÑÑ‹Ğ»ĞºĞ¸ (QR Code / Mobile)                 â”‚
â”‚                                                              â”‚
â”‚  ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ÑĞºĞ°Ğ½Ğ¸Ñ€ÑƒĞµÑ‚ QR Ğ¸Ğ»Ğ¸ Ğ¾Ñ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ ÑÑÑ‹Ğ»ĞºÑƒ            â”‚
â”‚  â†“                                                           â”‚
â”‚  GET /api/kyc/verify/{JWT_TOKEN}                            â”‚
â”‚  â†“                                                           â”‚
â”‚  Ğ¡ĞµÑ€Ğ²ĞµÑ€:                                                     â”‚
â”‚  - Ğ”ĞµĞºĞ¾Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ JWT                                           â”‚
â”‚  - ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ ÑÑ€Ğ¾Ğº Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ                                  â”‚
â”‚  - Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ (Ğ°Ğ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ°)                              â”‚
â”‚  - ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ metadata Ğ² KycSession                          â”‚
â”‚  â†“                                                           â”‚
â”‚  HTTP 302 Redirect â†’ https://api.sumsub.com/...             â”‚
â”‚  â†“                                                           â”‚
â”‚  ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¿Ğ¾Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚ Ğ½Ğ° Sumsub Ğ²ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° JWT Ğ¢Ğ¾ĞºĞµĞ½Ğ°

```typescript
interface VerifyTokenPayload {
  // Ğ˜Ğ´ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€Ñ‹
  userId: string;           // ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
  sessionId: string;        // ID KYC ÑĞµÑÑĞ¸Ğ¸
  provider: string;         // "sumsub" Ğ¸Ğ»Ğ¸ "kycaid"
  
  // Ğ¦ĞµĞ»ĞµĞ²Ğ¾Ğ¹ URL
  targetUrl: string;        // Ğ ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ URL Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€Ğ°
  
  // ĞœĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
  email?: string;           // Email Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
  phone?: string;           // Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
  
  // Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ
  exp: number;              // Timestamp Ğ¸ÑÑ‚ĞµÑ‡ĞµĞ½Ğ¸Ñ (Unix)
  iat: number;              // Timestamp ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ (Unix)
  jti: string;              // Unique token ID
}
```

### ĞŸÑ€ĞµĞ¸Ğ¼ÑƒÑ‰ĞµÑÑ‚Ğ²Ğ° Ğ ĞµÑˆĞµĞ½Ğ¸Ñ

1. **Ğ‘Ñ€ĞµĞ½Ğ´Ğ¸Ğ½Ğ³** ğŸ¨
   - Ğ¡ÑÑ‹Ğ»ĞºĞ¸ Ğ²Ñ‹Ğ³Ğ»ÑĞ´ÑÑ‚ ĞºĞ°Ğº Ñ‡Ğ°ÑÑ‚ÑŒ Ğ¿Ğ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ñ‹ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°
   - QR ĞºĞ¾Ğ´Ñ‹ Ñ Ğ´Ğ¾Ğ¼ĞµĞ½Ğ¾Ğ¼ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°

2. **ĞĞ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ°** ğŸ“Š
   - Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ²ÑĞµÑ… Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¾Ğ²
   - Tracking ĞºĞ¾Ğ½Ğ²ĞµÑ€ÑĞ¸Ğ¸ QR â†’ Ğ’ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ
   - ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ Ğ¿Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°

3. **Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ** ğŸ”’
   - JWT Ñ Ğ¸ÑÑ‚ĞµÑ‡ĞµĞ½Ğ¸ĞµĞ¼ ÑÑ€Ğ¾ĞºĞ° Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ
   - Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ³Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ (optional)
   - Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ½Ğ° ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ğµ ÑĞµÑ€Ğ²ĞµÑ€Ğ°

4. **Ğ“Ğ¸Ğ±ĞºĞ¾ÑÑ‚ÑŒ** ğŸ”„
   - ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ¼ĞµĞ½ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€Ğ° Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ ÑÑÑ‹Ğ»Ğ¾Ğº
   - Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ¾Ğ² Ğ² Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞ¼
   - A/B Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

5. **ĞŸÑ€Ğ¾ÑÑ‚Ğ¾Ñ‚Ğ°** âš¡
   - ĞĞµ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ² Sumsub
   - ĞĞµ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ Enterprise Ğ¿Ğ»Ğ°Ğ½Ğ°
   - Ğ›ĞµĞ³ĞºĞ¾ Ğ²Ğ½ĞµĞ´Ñ€Ğ¸Ñ‚ÑŒ Ğ¸ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°Ñ‚ÑŒ

---

## ğŸ“ ĞŸĞ»Ğ°Ğ½ Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸

### Ğ­Ñ‚Ğ°Ğ¿ 1: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Proxy Endpoint

**Ğ¤Ğ°Ğ¹Ğ»:** `src/app/api/kyc/verify/[token]/route.ts`

```typescript
/**
 * KYC Verification Proxy/Redirect
 * 
 * White-label KYC verification links
 * Example: https://app.bitflow.biz/api/kyc/verify/{token}
 */

import { NextRequest, NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';
import jwt from 'jsonwebtoken';

interface VerifyTokenPayload {
  userId: string;
  sessionId: string;
  provider: string;
  targetUrl: string;
  exp?: number;
}

export async function GET(
  request: NextRequest,
  { params }: { params: { token: string } }
): Promise<NextResponse> {
  try {
    const token = params.token;
    
    // 1. Decode JWT
    const secret = process.env.NEXTAUTH_SECRET!;
    const payload = jwt.verify(token, secret) as VerifyTokenPayload;
    
    // 2. Log access (analytics)
    await prisma.kycSession.update({
      where: { id: payload.sessionId },
      data: {
        metadata: {
          lastProxyAccess: new Date().toISOString(),
          proxyAccessCount: { increment: 1 }
        }
      }
    });
    
    // 3. Redirect to provider
    return NextResponse.redirect(payload.targetUrl);
    
  } catch (error) {
    // Redirect to KYC page with error
    return NextResponse.redirect(
      new URL('/kyc?error=invalid_link', request.url)
    );
  }
}
```

### Ğ­Ñ‚Ğ°Ğ¿ 2: ĞœĞ¾Ğ´Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Mobile Link Generation

**Ğ¤Ğ°Ğ¹Ğ»:** `src/app/api/kyc/mobile-link/route.ts`

Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ `mobileUrl` Ğ¾Ñ‚ Sumsub:

```typescript
// Generate white-label proxy URL
const secret = process.env.NEXTAUTH_SECRET!;
const proxyToken = jwt.sign(
  {
    userId,
    sessionId: kycSession.id,
    provider: providerId,
    targetUrl: mobileUrl,
    exp: Math.floor(Date.now() / 1000) + 3600 // 1 hour
  },
  secret
);

const whitelabelUrl = `${process.env.NEXTAUTH_URL}/api/kyc/verify/${proxyToken}`;

return NextResponse.json({
  success: true,
  mobileUrl: whitelabelUrl,  // Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ white-label URL
  originalUrl: mobileUrl,     // ĞÑ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ URL (Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸)
  externalActionId: data.externalActionId
});
```

### Ğ­Ñ‚Ğ°Ğ¿ 3: ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Frontend (QR Code)

**Ğ¤Ğ°Ğ¹Ğ»:** `src/app/(client)/kyc/page.tsx`

ĞĞ¸ĞºĞ°ĞºĞ¸Ñ… Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ½Ğµ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ! Frontend ÑƒĞ¶Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ `sumsubMobileUrl` Ğ¸Ğ· API.

### Ğ­Ñ‚Ğ°Ğ¿ 4: Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

1. **Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:**
   ```bash
   # Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ dev ÑĞµÑ€Ğ²ĞµÑ€
   npm run dev
   
   # ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ KYC ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ
   http://localhost:3000/kyc
   
   # ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ QR ĞºĞ¾Ğ´ - Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ:
   http://localhost:3000/api/kyc/verify/{TOKEN}
   ```

2. **Production Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:**
   ```bash
   # QR ĞºĞ¾Ğ´ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ:
   https://app.bitflow.biz/api/kyc/verify/{TOKEN}
   ```

3. **ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ€ĞµĞ´Ğ¸Ñ€ĞµĞºÑ‚Ğ°:**
   - ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ ÑÑÑ‹Ğ»ĞºÑƒ Ğ² Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğµ
   - Ğ”Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ¾Ğ¹Ñ‚Ğ¸ Ñ€ĞµĞ´Ğ¸Ñ€ĞµĞºÑ‚ Ğ½Ğ° Sumsub
   - ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¸ Ğ² ĞºĞ¾Ğ½ÑĞ¾Ğ»Ğ¸

---

## ğŸ”§ Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ£Ğ»ÑƒÑ‡ÑˆĞµĞ½Ğ¸Ñ

### 1. ĞĞ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ° Ğ¸ Tracking

```typescript
// Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ² metadata KycSession:
{
  proxyStats: {
    totalAccesses: number,
    firstAccess: string,
    lastAccess: string,
    userAgents: string[],
    ipAddresses: string[]
  }
}
```

### 2. Rate Limiting

```typescript
// Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ Ğ·Ğ»Ğ¾ÑƒĞ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ»ĞµĞ½Ğ¸Ğ¹
const accessCount = await getProxyAccessCount(sessionId);
if (accessCount > 10) {
  return NextResponse.json(
    { error: 'Too many requests' },
    { status: 429 }
  );
}
```

### 3. Custom Query Parameters

```typescript
// ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ¾Ğ²
const targetUrl = new URL(payload.targetUrl);
request.nextUrl.searchParams.forEach((value, key) => {
  targetUrl.searchParams.set(key, value);
});
```

### 4. Webhook Ğ´Ğ»Ñ ĞĞ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ¸

```typescript
// ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ² Ğ°Ğ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºÑƒ
await fetch('/api/analytics/track', {
  method: 'POST',
  body: JSON.stringify({
    event: 'kyc_link_accessed',
    userId: payload.userId,
    provider: payload.provider,
    timestamp: new Date().toISOString()
  })
});
```

---

## ğŸš€ Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ Ğ¨Ğ°Ğ³Ğ¸

1. âœ… Ğ˜Ğ·ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ Sumsub (Done)
2. âœ… ĞŸÑ€Ğ¾Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ‚ĞµĞºÑƒÑ‰ÑƒÑ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñƒ (Done)
3. â³ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ proxy endpoint
4. â³ ĞœĞ¾Ğ´Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ mobile-link API
5. â³ ĞŸÑ€Ğ¾Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾
6. â³ Ğ—Ğ°Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¸Ñ‚ÑŒ Ğ½Ğ° production
7. â³ ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ñ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¼ QR ĞºĞ¾Ğ´Ğ¾Ğ¼

---

## ğŸ“š Ğ¡ÑÑ‹Ğ»ĞºĞ¸

- [Sumsub WebSDK Documentation](https://docs.sumsub.com/sumsub/docs/websdk-settings)
- [Sumsub External Links API](https://docs.sumsub.com/sumsub/reference/generate-websdk-external-link)
- [JWT Best Practices](https://tools.ietf.org/html/rfc7519)

