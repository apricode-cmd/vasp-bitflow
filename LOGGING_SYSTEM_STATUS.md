# ‚úÖ –°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è - –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å

**–î–∞—Ç–∞:** 01.11.2025  
**–°—Ç–∞—Ç—É—Å:** –í—Å–µ —Å–∏—Å—Ç–µ–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### ‚úÖ AdminAuditLog (–õ–æ–≥–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤)
**–°—Ç–∞—Ç—É—Å:** –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ  
**–ó–∞–ø–∏—Å–µ–π –≤ –ë–î:** 4  
**–ü—Ä–∏–º–µ—Ä—ã:**
- ‚úÖ API_KEY_GENERATED
- ‚úÖ API_KEY_REVOKED (CRITICAL)
- ‚úÖ ORDER_STATUS_CHANGED

**–ß—Ç–æ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è:**
- –õ–æ–≥–∏–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞
- –°–æ–∑–¥–∞–Ω–∏–µ/–æ—Ç–∑—ã–≤ API –∫–ª—é—á–µ–π
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
- –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –∞–¥–º–∏–Ω–æ–≤
- –û–¥–æ–±—Ä–µ–Ω–∏–µ PayOut

### ‚úÖ UserAuditLog (–õ–æ–≥–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤)
**–°—Ç–∞—Ç—É—Å:** –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ  
**–ó–∞–ø–∏—Å–µ–π –≤ –ë–î:** 1  
**–ü—Ä–∏–º–µ—Ä—ã:**
- ‚úÖ PROFILE_UPDATED

**–ß—Ç–æ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è:**
- –õ–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
- –ó–∞–≥—Ä—É–∑–∫–∞ KYC –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- –ó–∞–≥—Ä—É–∑–∫–∞ proof of payment

### ‚úÖ SystemLog (–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è)
**–°—Ç–∞—Ç—É—Å:** –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ  
**–ó–∞–ø–∏—Å–µ–π –≤ –ë–î:** 1  
**–ü—Ä–∏–º–µ—Ä—ã:**
- ‚úÖ COINGECKO_API | API_CALL | /simple/price | 200 | 275ms

**–ß—Ç–æ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è:**
- CoinGecko API calls (–ø–æ–ª—É—á–µ–Ω–∏–µ –∫—É—Ä—Å–æ–≤)
- KYCAID webhooks
- –°–∏—Å—Ç–µ–º–Ω—ã–µ –æ—à–∏–±–∫–∏
- API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

---

## üéØ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

### 1. AdminAuditLog
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤

**–ü–æ–ª—è:**
- `adminId`, `adminEmail`, `adminRole` - –∫—Ç–æ
- `action`, `entityType`, `entityId` - —á—Ç–æ
- `diffBefore`, `diffAfter` - –∏–∑–º–µ–Ω–µ–Ω–∏—è
- `context` - IP, UA, device info
- `severity` - INFO, WARNING, CRITICAL
- `freezeChecksum` - SHA-256 –¥–ª—è immutability
- `mfaRequired`, `mfaMethod` - MFA tracking

**–°–µ—Ä–≤–∏—Å:** `src/lib/services/admin-audit-log.service.ts`  
**API:** `/api/admin/audit/admin-logs`

### 2. UserAuditLog
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –∫–ª–∏–µ–Ω—Ç–æ–≤

**–ü–æ–ª—è:**
- `userId`, `userEmail` - –∫—Ç–æ
- `action`, `entityType`, `entityId` - —á—Ç–æ
- `diffBefore`, `diffAfter` - –∏–∑–º–µ–Ω–µ–Ω–∏—è
- `context` - IP, UA, device info
- `freezeChecksum` - SHA-256 –¥–ª—è immutability
- **–ù–ï–¢ –ø–æ–ª—è `severity`** (—Ç–æ–ª—å–∫–æ –≤ AdminAuditLog)

**–°–µ—Ä–≤–∏—Å:** `src/lib/services/user-audit-log.service.ts`  
**API:** `/api/admin/audit/user-logs`

### 3. SystemLog
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è, webhooks, API calls

**–ü–æ–ª—è:**
- `source` - KYCAID_WEBHOOK, COINGECKO_API, TATUM_API
- `eventType` - WEBHOOK_RECEIVED, API_CALL, ERROR
- `level` - INFO, WARN, ERROR, CRITICAL
- `endpoint`, `method`, `statusCode`
- `payload`, `requestBody`, `responseBody`
- `responseTime` - performance tracking
- `errorMessage`, `errorStack`

**–°–µ—Ä–≤–∏—Å:** `src/lib/services/system-log.service.ts`  
**API:** `/api/admin/system-logs`

---

## üîÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### ‚úÖ –õ–æ–≥–∏–Ω (Admin + User)
**–§–∞–π–ª:** `src/app/api/auth/log-login/route.ts`  
**–õ–æ–≥–∏–∫–∞:**
- –ï—Å–ª–∏ `role === 'ADMIN'` ‚Üí AdminAuditLog
- –ï—Å–ª–∏ `role === 'CLIENT'` ‚Üí UserAuditLog

### ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞
**–§–∞–π–ª:** `src/app/api/admin/orders/[id]/route.ts`  
**–õ–æ–≥–∏–∫–∞:** 
- `auditService.logAdminAction()` ‚Üí AdminAuditLog
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç `diffBefore` –∏ `diffAfter`

### ‚úÖ CoinGecko API
**–§–∞–π–ª:** `src/lib/services/coingecko.ts`  
**–õ–æ–≥–∏–∫–∞:**
- –ü—Ä–∏ –∫–∞–∂–¥–æ–º –≤—ã–∑–æ–≤–µ `/simple/price`
- –õ–æ–≥–∏—Ä—É–µ—Ç: source, endpoint, statusCode, responseTime
- Non-blocking (–æ—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ –ª–æ–º–∞–µ—Ç API)

### ‚úÖ KYCAID Webhook
**–§–∞–π–ª:** `src/app/api/kyc/webhook/route.ts`  
**–õ–æ–≥–∏–∫–∞:**
- –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ webhook
- –õ–æ–≥–∏—Ä—É–µ—Ç: payload, signature verification, processing result

---

## üß™ –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### 1. AdminAuditLog
```bash
# 1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:3000/admin
# 2. Logout ‚Üí Login
# 3. –ò–∑–º–µ–Ω–∏—Ç–µ —Å—Ç–∞—Ç—É—Å –ª—é–±–æ–≥–æ –∑–∞–∫–∞–∑–∞
# 4. –û—Ç–∫—Ä–æ–π—Ç–µ /admin/audit ‚Üí –≤–∫–ª–∞–¥–∫–∞ "Admin Log"
# –î–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏: LOGIN, ORDER_STATUS_CHANGED
```

### 2. UserAuditLog
```bash
# 1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:3000/login (–∫–∞–∫ user)
# 2. Login
# 3. –û–±–Ω–æ–≤–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å
# 4. –û—Ç–∫—Ä–æ–π—Ç–µ /admin/audit ‚Üí –≤–∫–ª–∞–¥–∫–∞ "User Log"
# –î–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è: LOGIN, PROFILE_UPDATED
```

### 3. SystemLog
```bash
# –ú–µ—Ç–æ–¥ 1: –ß–µ—Ä–µ–∑ API
curl http://localhost:3000/api/rates

# –ú–µ—Ç–æ–¥ 2: –ß–µ—Ä–µ–∑ UI
# 1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:3000/buy
# 2. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—É—Ä—Å–æ–≤
# 3. –û—Ç–∫—Ä–æ–π—Ç–µ /admin/audit ‚Üí –≤–∫–ª–∞–¥–∫–∞ "System Logs"
# –î–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –∑–∞–ø–∏—Å—å: COINGECKO_API | API_CALL
```

---

## üìã UI —Å—Ç—Ä–∞–Ω–∏—Ü–∞ `/admin/audit`

### –í–∫–ª–∞–¥–∫–∏:
1. **Admin Log** - –ª–æ–≥–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ (AdminAuditLog)
2. **User Log** - –ª–æ–≥–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ (UserAuditLog)
3. **Critical Actions** - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –∞–¥–º–∏–Ω–æ–≤ + MFA —Å–æ–±—ã—Ç–∏—è
4. **System Logs** - —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è (SystemLog)
5. **Statistics** - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Å–µ–º –ª–æ–≥–∞–º

### Details Sheet (–ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏):
**–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π** –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ª–æ–≥–æ–≤, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
- Actor (Admin/User)
- Action & Entity
- Changes (diffBefore/diffAfter)
- Context (IP, UA, device)
- MFA info (–µ—Å–ª–∏ –±—ã–ª–æ)
- Compliance (severity, freezeChecksum)

---

## ‚úÖ Compliance —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

### Immutability (–Ω–µ–∏–∑–º–µ–Ω—è–µ–º–æ—Å—Ç—å)
‚úÖ –í—Å–µ –ª–æ–≥–∏ –∏–º–µ—é—Ç `freezeChecksum` (SHA-256)  
‚úÖ –ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å/—É–¥–∞–ª—è—Ç—å –ª–æ–≥–∏ —á–µ—Ä–µ–∑ UI  
‚úÖ `createdAt` - —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏

### Data Retention (—Ö—Ä–∞–Ω–µ–Ω–∏–µ)
‚è≥ TODO: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å retention policy (‚â• 5 –ª–µ—Ç –ø–æ compliance)  
‚è≥ TODO: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞—Ä—Ö–∏–≤–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤

### Audit Trail (–ø–æ–ª–Ω–æ—Ç–∞)
‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è  
‚úÖ IP address, User Agent, Device info  
‚úÖ Before/After states (diff)  
‚úÖ MFA verification tracking

---

## üöÄ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å

### ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:
- [x] AdminAuditLog —Å –ø–æ–ª–Ω—ã–º–∏ compliance –ø–æ–ª—è–º–∏
- [x] UserAuditLog —Å –ø–æ–ª–Ω—ã–º–∏ compliance –ø–æ–ª—è–º–∏
- [x] SystemLog –¥–ª—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π
- [x] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–Ω–∞ (Admin + User)
- [x] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞
- [x] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ CoinGecko API calls
- [x] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ KYCAID webhooks
- [x] UI —Å—Ç—Ä–∞–Ω–∏—Ü–∞ `/admin/audit` —Å 5 –≤–∫–ª–∞–¥–∫–∞–º–∏
- [x] –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π Details Sheet
- [x] –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫
- [x] Statistics tab (–∞–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö)

### ‚è≥ TODO (Phase 2):
- [ ] Retention policy automation
- [ ] Export to CSV/JSON with encryption
- [ ] Real-time alerts for CRITICAL events
- [ ] Compliance review workflow
- [ ] Log integrity verification (checksum validation)
- [ ] GeoIP –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è country/city
- [ ] Rate limiting –¥–ª—è System Logs

---

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!**

- ‚úÖ –í—Å–µ 3 —Ç–∞–±–ª–∏—Ü—ã –ª–æ–≥–æ–≤ —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ –†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–∏—à—É—Ç—Å—è
- ‚úÖ UI –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –ª–æ–≥–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ –ù–µ—Ç mock –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ Compliance requirements –≤—ã–ø–æ–ª–Ω–µ–Ω—ã

**–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
1. Login/Logout ‚Üí AdminAuditLog
2. –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ ‚Üí AdminAuditLog
3. –û—Ç–∫—Ä—ã—Ç–∏–µ /buy ‚Üí SystemLog (CoinGecko)

**–í—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!** üöÄ

