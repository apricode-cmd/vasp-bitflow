# üìä Virtual IBAN Balance Operations - –ê–Ω–∞–ª–∏–∑ –∏ –ü–ª–∞–Ω –£–ª—É—á—à–µ–Ω–∏–π

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ BCB Virtual IBANs

### üìå –ö–ª—é—á–µ–≤–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ:

**BCB Group –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Segregated Account –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É:**

```
Physical Layer (BCB):
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ Segregated Account (94092443)          ‚îÇ
  ‚îÇ IBAN: DK6589000025309667               ‚îÇ
  ‚îÇ Total Physical Balance: ‚Ç¨1,000         ‚îÇ  ‚Üê –ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ô —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –±–∞–ª–∞–Ω—Å
  ‚îÇ                                         ‚îÇ
  ‚îÇ ‚îú‚îÄ Virtual IBAN: DK8089000025328603   ‚îÇ
  ‚îÇ ‚îú‚îÄ Virtual IBAN: DK8589000025328610   ‚îÇ
  ‚îÇ ‚îú‚îÄ Virtual IBAN: DK9089000025328617   ‚îÇ
  ‚îÇ ‚îú‚îÄ Virtual IBAN: DK6889000025329304   ‚îÇ
  ‚îÇ ‚îî‚îÄ Virtual IBAN: DK9689000025329479   ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Logical Layer (Our Database):
  Virtual IBAN A (User A): ‚Ç¨600  ‚Üê –õ–æ–≥–∏—á–µ—Å–∫–∏–π –±–∞–ª–∞–Ω—Å
  Virtual IBAN B (User B): ‚Ç¨400  ‚Üê –õ–æ–≥–∏—á–µ—Å–∫–∏–π –±–∞–ª–∞–Ω—Å
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  Total: ‚Ç¨1,000 ‚úÖ Must match BCB!
```

**–í–∞–∂–Ω–æ:**
- BCB **–ù–ï –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç** –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –±–∞–ª–∞–Ω—Å—ã Virtual IBANs
- BCB –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ **–æ–±—â–∏–π –±–∞–ª–∞–Ω—Å** Segregated Account
- **–ù–∞—à–∞ –∑–∞–¥–∞—á–∞:** –≤–µ—Å—Ç–∏ —É—á–µ—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –±–∞–ª–∞–Ω—Å–æ–≤ –ª–æ–∫–∞–ª—å–Ω–æ
- **–ö–ª—é—á–µ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ:** Œ£(–ª–æ–∫–∞–ª—å–Ω—ã–µ –±–∞–ª–∞–Ω—Å—ã) = BCB segregated balance

---

## üîç –¢–µ–∫—É—â–∞—è –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### ‚úÖ –ß—Ç–æ —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:

#### 1. **–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ (Top-Up)**

**üéØ –î–≤–∞ —Å–ø–æ—Å–æ–±–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è—Ö:**

##### 1.1 Webhook (Primary) - Real-time
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: `POST /api/webhooks/bcb/virtual-iban`
- ‚úÖ BCB –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å—Ä–∞–∑—É –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞
- ‚úÖ Webhook payload —Å–æ–¥–µ—Ä–∂–∏—Ç:
  - `transactionId` - ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ BCB
  - `iban` - –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π Virtual IBAN –ø–æ–ª—É—á–∞—Ç–µ–ª—è ‚Üê **–¢–∞–∫ –º—ã –∑–Ω–∞–µ–º –∫–∞–∫–æ–π —Å—É–±-–∞–∫–∫–∞—É–Ω—Ç!**
  - `amount` - —Å—É–º–º–∞
  - `currency` - –≤–∞–ª—é—Ç–∞
  - `senderName` - –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å
  - `reference` - —Ä–µ—Ñ–µ—Ä–µ–Ω—Å –¥–ª—è matching
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞—á–∏—Å–ª–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ (`addBalance`)
- ‚úÖ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (–ø—Ä–æ–≤–µ—Ä–∫–∞ `providerTransactionId`)
- ‚úÖ Atomic transactions (Prisma)
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ `TopUpRequest` —Å –∏–Ω–≤–æ–π—Å–∞–º–∏
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** Webhook –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–ø—É—â–µ–Ω (network, downtime, retry failure)

##### 1.2 Polling (Fallback) - NOT IMPLEMENTED
- ‚ùå **–ù–µ—Ç —Ä–µ–≥—É–ª—è—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ BCB Client API**
- BCB –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç: `GET /v1/accounts/{accountId}/payments`
- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
  - `dateFrom` / `dateTo` - —Ñ–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–∞–º
  - `pageIndex` / `pageSize` - –ø–∞–≥–∏–Ω–∞—Ü–∏—è (–º–∞–∫—Å 1000)
- –û—Ç–≤–µ—Ç: –º–∞—Å—Å–∏–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Å `transactionId`, `status`, `amount`, `currency`
- **–ù—É–∂–Ω–æ:** Cron job –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–ª—è Production:**
```typescript
// –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –º–∏–Ω—É—Ç
cron.schedule('*/5 * * * *', async () => {
  const dateFrom = new Date(Date.now() - 10 * 60 * 1000);
  const payments = await bcbAdapter.clientApiRequest(
    'GET',
    `/v1/accounts/${segregatedAccountId}/payments?dateFrom=${dateFrom.toISOString()}`
  );
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
  for (const payment of payments.results) {
    // –ï—Å–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É–∂–µ –µ—Å—Ç—å –≤ –±–∞–∑–µ - skip
    const exists = await prisma.virtualIbanTransaction.findUnique({
      where: { providerTransactionId: payment.transactionId }
    });
    
    if (!exists && payment.status === 'Settled') {
      // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ webhook
      await virtualIbanService.processIncomingTransaction(payment);
    }
  }
});
```

#### 2. **–°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ (Debit)**
- ‚úÖ –°–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã (`deductBalance`)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤
- ‚úÖ Atomic transactions
- ‚úÖ Tolerance –¥–ª—è float precision (0.01 EUR)
- ‚úÖ –ü—Ä–∏–≤—è–∑–∫–∞ –∫ Order —á–µ—Ä–µ–∑ `orderId`

#### 3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**
- ‚úÖ Row-level locking —á–µ—Ä–µ–∑ Prisma transactions
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ (ACTIVE)
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –±–∞–ª–∞–Ω—Å–∞ –ø–µ—Ä–µ–¥ —Å–ø–∏—Å–∞–Ω–∏–µ–º

---

## ‚ùå –ß—Ç–æ –ù–ï —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:

### 1. **Polling –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π**
‚ùå **–ù–µ—Ç fallback –º–µ—Ö–∞–Ω–∏–∑–º–∞ –Ω–∞ —Å–ª—É—á–∞–π –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö webhook'–æ–≤**

**–ü—Ä–æ–±–ª–µ–º–∞:**
- Webhook –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–ø—É—â–µ–Ω (network issues, server downtime, BCB retry failure)
- –ù–µ—Ç —Å–ø–æ—Å–æ–±–∞ –æ–±–Ω–∞—Ä—É–∂–∏—Ç—å –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏
- –ë–∞–ª–∞–Ω—Å –º–æ–∂–µ—Ç —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–∏—Ç—å Cron job –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —á–µ—Ä–µ–∑ `GET /v1/accounts/{accountId}/payments`
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –º–∏–Ω—É—Ç –∫–∞–∂–¥—ã–µ X –º–∏–Ω—É—Ç
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### 2. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –±–∞–ª–∞–Ω—Å–∞ —Å BCB**
‚ùå **–ù–µ—Ç —Ä–µ–≥—É–ª—è—Ä–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å —Ä–µ–∞–ª—å–Ω—ã–º –±–∞–ª–∞–Ω—Å–æ–º BCB**

**–í–∞–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å:**
- BCB –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ **–æ–±—â–∏–π –±–∞–ª–∞–Ω—Å Segregated Account**
- Endpoint: `GET /v3/balances/{segregatedAccountId}`
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: **–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ** –¥–ª—è –≤—Å–µ–≥–æ Segregated Account
- **–ù–ï –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç** –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –±–∞–ª–∞–Ω—Å—ã Virtual IBANs

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- –ë–∞–ª–∞–Ω—Å —Ö—Ä–∞–Ω–∏—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ `VirtualIbanAccount.balance` (–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ)
- –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ webhook'–∞—Ö
- –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Å BCB

**–ß—Ç–æ –Ω—É–∂–Ω–æ:**
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å: `Œ£(–≤—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –±–∞–ª–∞–Ω—Å—ã) === BCB segregated balance`
- –ï—Å–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Üí ALERT –¥–ª—è manual reconciliation
- –≠—Ç–æ –∑–∞—â–∏—Ç–∞ –æ—Ç –±—É—Ö–≥–∞–ª—Ç–µ—Ä—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –∏ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
async function validateTotalBalance() {
  // 1. –ü–æ–ª—É—á–∞–µ–º –æ–±—â–∏–π –±–∞–ª–∞–Ω—Å –∏–∑ BCB
  const bcbBalance = await bcbAdapter.getBalance(segregatedAccountId);
  
  // 2. –°—É–º–º–∏—Ä—É–µ–º –≤—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –±–∞–ª–∞–Ω—Å—ã
  const localSum = await prisma.virtualIbanAccount.aggregate({
    where: { status: 'ACTIVE' },
    _sum: { balance: true }
  });
  
  // 3. –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º
  const diff = Math.abs(bcbBalance - localSum._sum.balance);
  
  if (diff > 0.01) { // tolerance
    await sendAlertToAdmin({
      type: 'BALANCE_MISMATCH',
      bcbBalance,
      localSum: localSum._sum.balance,
      diff
    });
  }
}
```

### 3. **–ò—Å—Ö–æ–¥—è—â–∏–µ –ø–ª–∞—Ç–µ–∂–∏ (BCB Payment API)**
‚ùå **–ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤ —Å Virtual IBAN**

BCB API –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç:
```
POST /v1/accounts/{accountId}/virtual/{iban}/payment
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–∞—à–∞ —Å–∏—Å—Ç–µ–º–∞ —Å–æ–∑–¥–∞–µ—Ç Virtual IBAN —á–µ—Ä–µ–∑ `CreateNoBankDetailsVirtualAccount`, —á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç:
- ‚úÖ –ú–æ–∂–µ–º –ü–†–ò–ù–ò–ú–ê–¢–¨ –ø–ª–∞—Ç–µ–∂–∏
- ‚ùå –ù–ï –º–æ–∂–µ–º –û–¢–ü–†–ê–í–õ–Ø–¢–¨ –ø–ª–∞—Ç–µ–∂–∏ (—Ç—Ä–µ–±—É—é—Ç—Å—è bank details –≤–ª–∞–¥–µ–ª—å—Ü–∞)

### 4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ VOP (Verification of Payee)**
‚ö†Ô∏è **–ß–∞—Å—Ç–∏—á–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ** (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤—Ö–æ–¥—è—â–∏—Ö –ø–ª–∞—Ç–µ–∂–µ–π)
- ‚úÖ Webhook –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç VOP —Å—Ç–∞—Ç—É—Å—ã
- ‚úÖ Admin UI –¥–ª—è approve/reject
- ‚ùå –ù–µ—Ç VOP –¥–ª—è –∏—Å—Ö–æ–¥—è—â–∏—Ö –ø–ª–∞—Ç–µ–∂–µ–π

### 4. **Multi-currency**
‚ùå **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç–æ–ª—å–∫–æ EUR**
- BCB –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç GBP
- –ù–∞—à–∞ —Å–∏—Å—Ç–µ–º–∞ –∂–µ—Å—Ç–∫–æ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ EUR

### 5. **–ö–æ–º–∏—Å—Å–∏–∏ –∏ –ª–∏–º–∏—Ç—ã**
‚ùå **–ù–µ—Ç —É—á–µ—Ç–∞ –∫–æ–º–∏—Å—Å–∏–π BCB**
- BCB –≤–∑–∏–º–∞–µ—Ç –∫–æ–º–∏—Å—Å–∏–∏ –∑–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏
- –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–Ω–µ–≤–Ω—ã—Ö/–º–µ—Å—è—á–Ω—ã—Ö –ª–∏–º–∏—Ç–æ–≤

---

## üìã –ü–ª–∞–Ω –£–ª—É—á—à–µ–Ω–∏–π –¥–ª—è Production

### üéØ **Phase 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è (Must Have)**

#### 1.1 Polling –¥–ª—è fallback –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ CRITICAL

**–ü—Ä–æ–±–ª–µ–º–∞:** 
- Webhook –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–ø—É—â–µ–Ω
- –ù–µ—Ç —Å–ø–æ—Å–æ–±–∞ –æ–±–Ω–∞—Ä—É–∂–∏—Ç—å –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏
- –ë–∞–ª–∞–Ω—Å –º–æ–∂–µ—Ç —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è –±–µ–∑ –Ω–∞—à–µ–≥–æ –≤–µ–¥–æ–º–∞

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// cron/sync-virtual-iban-payments.ts
import { CronJob } from 'cron';

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–æ–≤—ã–µ –ø–ª–∞—Ç–µ–∂–∏ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
 * –ò—â–µ—Ç –ø–ª–∞—Ç–µ–∂–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –º–∏–Ω—É—Ç (overlap –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
 */
export const syncVirtualIbanPaymentsCron = new CronJob(
  '*/5 * * * *', // –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
  async () => {
    console.log('[Cron] Syncing Virtual IBAN payments...');
    
    try {
      const bcbAdapter = await integrationFactory.getVirtualIbanProvider();
      const dateFrom = new Date(Date.now() - 10 * 60 * 1000); // 10 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥
      
      // –ü–æ–ª—É—á–∞–µ–º –ø–ª–∞—Ç–µ–∂–∏ –¥–ª—è segregated account
      const response = await bcbAdapter.clientApiRequest(
        'GET',
        `/v1/accounts/${segregatedAccountId}/payments?dateFrom=${dateFrom.toISOString()}&pageSize=100`
      );
      
      console.log(`[Cron] Found ${response.count} payments`);
      
      // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π –ø–ª–∞—Ç–µ–∂
      for (const transactionId of response.results) {
        // –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª–∏ –ø–ª–∞—Ç–µ–∂–∞
        const payment = await bcbAdapter.clientApiRequest(
          'GET',
          `/v1/accounts/${segregatedAccountId}/payments/transaction/${transactionId}`
        );
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –≤ –±–∞–∑–µ
        const exists = await prisma.virtualIbanTransaction.findUnique({
          where: { providerTransactionId: payment.transactionId }
        });
        
        if (!exists && payment.status === 'Settled') {
          console.log(`[Cron] Processing missed payment: ${payment.transactionId}`);
          
          // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ webhook (—Ç–∞ –∂–µ –ª–æ–≥–∏–∫–∞)
          await virtualIbanService.processIncomingTransaction({
            tx_id: payment.transactionId,
            amount: payment.amount,
            currency: payment.currency,
            // ... map other fields
          });
        }
      }
      
      console.log('[Cron] Sync completed successfully');
    } catch (error) {
      console.error('[Cron] Sync failed:', error);
      // –û—Ç–ø—Ä–∞–≤–∏—Ç—å alert –∞–¥–º–∏–Ω—É
      await sendAlertToAdmin({
        type: 'CRON_FAILED',
        job: 'sync-virtual-iban-payments',
        error: error.message
      });
    }
  }
);
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ webhook'–∏
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
- ‚úÖ Overlap (10 –º–∏–Ω) –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–∞ –∂–µ –ª–æ–≥–∏–∫–∞ —á—Ç–æ –∏ webhook

#### 1.2 –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞ —Å BCB
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ CRITICAL

**–ü—Ä–æ–±–ª–µ–º–∞:** 
- –õ–æ–∫–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –º–æ–∂–µ—Ç —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è
- Webhook –º–æ–≥—É—Ç –±—ã—Ç—å –ø—Ä–æ–ø—É—â–µ–Ω—ã
- –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–¥ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
class VirtualIbanBalanceService {
  /**
   * –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –±–∞–ª–∞–Ω—Å —Å BCB –ø–µ—Ä–µ–¥ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
   */
  async syncBalanceFromProvider(accountId: string): Promise<number> {
    // 1. –ü–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å –∏–∑ BCB API
    const bcbBalance = await bcbAdapter.getBalance(accountId);
    
    // 2. –°—Ä–∞–≤–Ω–∏—Ç—å —Å –ª–æ–∫–∞–ª—å–Ω—ã–º
    const localAccount = await prisma.virtualIbanAccount.findUnique({
      where: { id: accountId }
    });
    
    // 3. –ï—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ > tolerance, –æ–±–Ω–æ–≤–∏—Ç—å –∏ –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å
    const diff = Math.abs(bcbBalance.available - localAccount.balance);
    if (diff > 0.01) {
      console.warn(`Balance mismatch: BCB=${bcbBalance.available}, Local=${localAccount.balance}`);
      
      await prisma.virtualIbanAccount.update({
        where: { id: accountId },
        data: { 
          balance: bcbBalance.available,
          lastBalanceUpdate: new Date()
        }
      });
    }
    
    return bcbBalance.available;
  }
  
  /**
   * –û–±–Ω–æ–≤–∏—Ç—å deductBalance —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π
   */
  async deductBalanceWithSync(
    accountId: string,
    amount: number,
    orderId: string
  ) {
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ–¥ —Å–ø–∏—Å–∞–Ω–∏–µ–º
    await this.syncBalanceFromProvider(accountId);
    
    // –ó–∞—Ç–µ–º —Å–ø–∏—Å–∞—Ç—å
    return this.deductBalance(accountId, amount, orderId);
  }
}
```

**Cron job –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:**
```typescript
// cron: every 5 minutes
async function syncAllActiveBalances() {
  const accounts = await prisma.virtualIbanAccount.findMany({
    where: { status: 'ACTIVE' }
  });
  
  for (const account of accounts) {
    try {
      await virtualIbanBalanceService.syncBalanceFromProvider(account.id);
    } catch (error) {
      console.error(`Failed to sync ${account.id}:`, error);
    }
  }
}
```

---

#### 1.2 –†–µ–∫–æ–Ω—Å–∏–ª—è—Ü–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ CRITICAL

**–ü—Ä–æ–±–ª–µ–º–∞:**
- Webhook –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–ø—É—â–µ–Ω
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ —É—á—Ç–µ–Ω—ã

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
/**
 * –†–µ–∫–æ–Ω—Å–∏–ª—è—Ü–∏—è: –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–∑ BCB –∏ —Å–≤–µ—Ä–∏—Ç—å —Å –ª–æ–∫–∞–ª—å–Ω—ã–º–∏
 */
async function reconcileTransactions(
  accountId: string,
  dateFrom: Date,
  dateTo: Date
) {
  // 1. –ü–æ–ª—É—á–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–∑ BCB
  const bcbTransactions = await bcbAdapter.getTransactions(accountId, {
    dateFrom,
    dateTo
  });
  
  // 2. –ü–æ–ª—É—á–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
  const localTransactions = await prisma.virtualIbanTransaction.findMany({
    where: {
      virtualIbanId: accountId,
      processedAt: { gte: dateFrom, lte: dateTo }
    }
  });
  
  // 3. –ù–∞–π—Ç–∏ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ
  const missing = bcbTransactions.filter(bcbTx => 
    !localTransactions.find(localTx => 
      localTx.providerTransactionId === bcbTx.tx_id
    )
  );
  
  // 4. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ
  for (const tx of missing) {
    console.warn(`Missing transaction found: ${tx.tx_id}`);
    await virtualIbanBalanceService.addBalance(
      accountId,
      tx.amount,
      tx.tx_id,
      tx.reference,
      {
        senderName: tx.senderName,
        senderIban: tx.senderIban
      }
    );
  }
  
  return missing.length;
}
```

---

#### 1.3 –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∞—É–¥–∏—Ç
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü† HIGH

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// –ù–æ–≤–∞—è –º–æ–¥–µ–ª—å –¥–ª—è –∞—É–¥–∏—Ç–∞
model VirtualIbanBalanceAudit {
  id          String   @id @default(cuid())
  accountId   String
  operation   String   // DEBIT, CREDIT, SYNC, RECONCILE
  amountBefore Float
  amountAfter  Float
  amount       Float
  reason       String
  metadata     Json?
  createdAt    DateTime @default(now())
  
  @@index([accountId, createdAt])
}
```

---

### üéØ **Phase 2: –í–∞–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (Should Have)**

#### 2.1 –ò—Å—Ö–æ–¥—è—â–∏–µ –ø–ª–∞—Ç–µ–∂–∏ (Withdrawals)
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° MEDIUM

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å bank details (IBAN/BIC)
2. –û–±–Ω–æ–≤–∏—Ç—å Virtual Account —á–µ—Ä–µ–∑ BCB API
3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å withdraw —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

**–°—Ö–µ–º–∞:**
```typescript
// 1. –û–±–Ω–æ–≤–∏—Ç—å VirtualIbanAccount –º–æ–¥–µ–ª—å
model VirtualIbanAccount {
  // ... existing fields
  ownerIban      String?  // Owner's bank account IBAN
  ownerBic       String?  // Owner's bank account BIC
  canWithdraw    Boolean  @default(false) // Flag if withdrawals enabled
}

// 2. API –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è bank details
PUT /api/client/virtual-iban/:id/bank-details
{
  iban: "DE89370400440532013000",
  bic: "COBADEFFXXX"
}

// 3. –û–±–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ BCB Client API
PUT /v1/accounts/{accountId}/virtual/{iban}/owner-bank-details
{
  iban: "...",
  bicSwift: "..."
}

// 4. Withdraw API
POST /api/client/virtual-iban/:id/withdraw
{
  amount: 100.00,
  reason: "Withdraw to personal account"
}

// 5. BCB Payment API
POST /v1/accounts/{accountId}/virtual/{iban}/payment
{
  currency: "EUR",
  amount: "100.00",
  reference: "Withdrawal",
  nonce: "unique-nonce",
  reason: "User withdrawal"
}
```

**Flow:**
```
User requests withdrawal
  ‚Üì
Check if bank details provided ‚Üí If NO: require bank details
  ‚Üì
Validate balance
  ‚Üì
Create WithdrawalRequest (status: PENDING)
  ‚Üì
Call BCB Payment API
  ‚Üì
BCB processes (async)
  ‚Üì
Webhook updates status (SETTLED/REJECTED)
  ‚Üì
If SETTLED: deduct from local balance
  ‚Üì
Update WithdrawalRequest (status: COMPLETED)
```

---

#### 2.2 –õ–∏–º–∏—Ç—ã –∏ –∫–æ–º–∏—Å—Å–∏–∏
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° MEDIUM

**–°—Ö–µ–º–∞:**
```typescript
// –¢–∞–±–ª–∏—Ü–∞ –ª–∏–º–∏—Ç–æ–≤
model VirtualIbanLimits {
  id              String  @id @default(cuid())
  accountId       String  @unique
  dailyInLimit    Float   // –î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç –≤—Ö–æ–¥—è—â–∏—Ö
  dailyOutLimit   Float   // –î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç –∏—Å—Ö–æ–¥—è—â–∏—Ö
  monthlyInLimit  Float
  monthlyOutLimit Float
  dailyInUsed     Float   @default(0)
  dailyOutUsed    Float   @default(0)
  monthlyInUsed   Float   @default(0)
  monthlyOutUsed  Float   @default(0)
  lastResetDaily  DateTime
  lastResetMonthly DateTime
  
  @@index([accountId])
}

// –ö–æ–º–∏—Å—Å–∏–∏
model VirtualIbanFee {
  id          String  @id @default(cuid())
  type        String  // INBOUND, OUTBOUND, MONTHLY_MAINTENANCE
  feeFixed    Float   // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è
  feePercent  Float   // –ü—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è
  minFee      Float   // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è
  maxFee      Float?  // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –ø–µ—Ä–µ–¥ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
async function checkLimits(accountId: string, amount: number, type: 'IN' | 'OUT') {
  const limits = await prisma.virtualIbanLimits.findUnique({
    where: { accountId }
  });
  
  if (type === 'OUT') {
    if (limits.dailyOutUsed + amount > limits.dailyOutLimit) {
      throw new Error('Daily withdrawal limit exceeded');
    }
  }
  
  // Update usage
  await prisma.virtualIbanLimits.update({
    where: { accountId },
    data: {
      dailyOutUsed: { increment: amount }
    }
  });
}
```

---

#### 2.3 –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç—ã
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° MEDIUM

**–ú–µ—Ç—Ä–∏–∫–∏:**
- Balance sync mismatches
- Failed webhooks
- Missing transactions (reconciliation)
- High volume activity (suspicious)
- VOP rejections

**Alerts:**
```typescript
// Email alerts –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
async function sendBalanceMismatchAlert(accountId: string, diff: number) {
  await sendEmail({
    to: 'admin@example.com',
    subject: `‚ö†Ô∏è Balance Mismatch: ${accountId}`,
    body: `
      Virtual IBAN ${accountId} has a balance mismatch of ‚Ç¨${diff.toFixed(2)}
      
      Please investigate immediately.
    `
  });
}
```

---

### üéØ **Phase 3: Nice to Have**

#### 3.1 Multi-currency (GBP support)
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ LOW

#### 3.2 Automated batch payments
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ LOW

#### 3.3 Real-time balance notifications
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ LOW

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 1. **Separation of Concerns**
```
VirtualIbanBalanceService (Business Logic)
  ‚Üì
BCBGroupAdapter (Provider Integration)
  ‚Üì
BCB API
```

### 2. **Event-Driven Architecture**
```typescript
// –°–æ–±—ã—Ç–∏—è –¥–ª—è —Ä–µ–∞–∫—Ü–∏–π
events.on('balance.credited', async (data) => {
  // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
  await notificationService.send(data.userId, {
    type: 'BALANCE_CREDITED',
    amount: data.amount
  });
});

events.on('balance.low', async (data) => {
  // –ê–ª–µ—Ä—Ç –ø—Ä–∏ –Ω–∏–∑–∫–æ–º –±–∞–ª–∞–Ω—Å–µ
  if (data.balance < 10) {
    await sendLowBalanceAlert(data.userId);
  }
});
```

### 3. **Caching Strategy**
```typescript
// Redis –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ (short TTL)
await redis.set(
  `viban:balance:${accountId}`,
  balance,
  'EX',
  60 // 1 minute TTL
);
```

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è Production

### –ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º:
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å balance sync
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å reconciliation cron job (daily)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∞—É–¥–∏—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç—ã
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å webhook reliability
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å backup –¥–ª—è –±–∞–ª–∞–Ω—Å–∞
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ API endpoints
- [ ] –û–±—É—á–∏—Ç—å support –∫–æ–º–∞–Ω–¥—É

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:
- [ ] Dashboard —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ –±–∞–ª–∞–Ω—Å–∞
- [ ] Alert –Ω–∞ mismatch > ‚Ç¨1.00
- [ ] Daily reconciliation report
- [ ] Webhook failure tracking

---

## üìä –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è

| Feature | Priority | Impact | Effort | Status |
|---------|----------|--------|--------|--------|
| Balance Sync | üî¥ CRITICAL | High | Medium | ‚ùå TODO |
| Reconciliation | üî¥ CRITICAL | High | Medium | ‚ùå TODO |
| Audit Logging | üü† HIGH | Medium | Low | ‚ùå TODO |
| Withdrawals | üü° MEDIUM | High | High | ‚ùå TODO |
| Limits & Fees | üü° MEDIUM | Medium | Medium | ‚ùå TODO |
| Multi-currency | üü¢ LOW | Low | High | ‚ùå TODO |

---

## üí∞ Cost-Benefit Analysis

### Option 1: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç (Phase 1 only)
**–°—Ç–æ–∏–º–æ—Å—Ç—å:** ~16-24 —á–∞—Å–æ–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å –±–∞–ª–∞–Ω—Å–æ–≤
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—å
- Compliance

### Option 2: –ü–æ–ª–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç (Phase 1 + 2)
**–°—Ç–æ–∏–º–æ—Å—Ç—å:** ~40-60 —á–∞—Å–æ–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –í—Å–µ –∏–∑ Option 1
- Withdrawals —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
- Compliance —Å –ª–∏–º–∏—Ç–∞–º–∏
- –ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: ‚úÖ **–ù–∞—á–∞—Ç—å —Å Phase 1, –∑–∞—Ç–µ–º Phase 2**

---

## üîó BCB API Reference

### –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ endpoints:
- ‚úÖ `POST /v2/accounts/{accountId}/virtual` - Create Virtual IBAN
- ‚úÖ `GET /v1/accounts/{accountId}/virtual/all-account-data` - List Virtual IBANs
- ‚ùå `GET /v4/balance/{accountId}` - Get Balance (TODO)
- ‚ùå `GET /v1/accounts/{accountId}/payments` - Get Payments (TODO)
- ‚ùå `POST /v1/accounts/{accountId}/virtual/{iban}/payment` - Send Payment (TODO)
- ‚úÖ `POST /v1/accounts/{accountId}/virtual/{iban}/close` - Close Account
- ‚ùå `PUT /v1/accounts/{accountId}/virtual/{iban}/owner-bank-details` - Update Bank Details (TODO)

---

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∫—Ä—ã–≤–∞–µ—Ç **–±–∞–∑–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏** (–ø—Ä–∏–µ–º –ø–ª–∞—Ç–µ–∂–µ–π, —Å–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞), –Ω–æ –¥–ª—è **production-ready** —Å–∏—Å—Ç–µ–º—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:

1. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –±–∞–ª–∞–Ω—Å–∞** —Å BCB (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏)
2. **–†–µ–∫–æ–Ω—Å–∏–ª—è—Ü–∏—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π** (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—å)
3. **–ê—É–¥–∏—Ç –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** (compliance –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)

–î–ª—è **–ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ** —Å–µ—Ä–≤–∏—Å–∞ Virtual IBAN –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω—ã:

4. **Withdrawals** (–≤—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤)
5. **–õ–∏–º–∏—Ç—ã –∏ –∫–æ–º–∏—Å—Å–∏–∏** (compliance)

**–í—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ Phase 1:** ~2-3 –Ω–µ–¥–µ–ª–∏
**–í—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ Phase 2:** +3-4 –Ω–µ–¥–µ–ª–∏

---

**–î–∞—Ç–∞:** 2025-12-04
**–ê–≤—Ç–æ—Ä:** AI Assistant
**–°—Ç–∞—Ç—É—Å:** Proposal for Review

